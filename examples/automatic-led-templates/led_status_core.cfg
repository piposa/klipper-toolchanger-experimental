####################################### MAIN LED TEMPLATES FOR NOZZLE AND LOGO #######################################

[gcode_macro DEBUG_LED]
description: "Toggle debugging for 'T<tool_number> (default: active)'"
gcode:
  {% set cur = printer['gcode_macro _toolchanger_led_vars'].get('debug', None) %}
  {% set tn = params.get('T', printer.toolchanger.tool_number)|string %}
  {% if cur is not none %}
    {% set cur = cur|string|replace(tn, '') if tn in cur|string else cur|string ~ tn %}
    SET_GCODE_VARIABLE MACRO='_toolchanger_led_vars' VARIABLE='debug' VALUE="{cur|string}"
  {% endif %}

#---< your templates can also call this to stay on track with the same global brightness setting.
[display_template _global_brightness_scalar]
param_rgbw_list: [0.0, 0.0, 0.0, 0.0]
text:
    {%- set lowest = 1.0 / 254.0 -%}
    {%- set bright = printer['gcode_macro _toolchanger_led_vars'].get('global_brightness', 1.0) -%}
    {%- for color in param_rgbw_list if param_rgbw_list is sequence and param_rgbw_list|length == 4 -%} 
        {',' if not loop.first else ''} {[color|float(0) * bright, (lowest * (color|float(0) > lowest))]|max}
    {%- else -%}
        1,0,0,0
    {%- endfor -%}


#---< cache heavy logo status detection once per refresh
[display_template logo_status]
param_tn: 'None'
param_idx: 0
param_max_idx: 0
text:
    {% set pos_tol, vel_tol, brush_tol = 0.25, 0.1, 5 %}
    {% set templates   = printer.printer.lookup_object('display_template').get_display_templates() %}
    {% set SELF        = templates.logo_status if 'logo_status' in templates %}
    {% set CACHE_KEY   = '__logo_status_cache__' %}

    {% set TOOL_NUMBER     = param_tn|int %}

    {% set p               = printer %}
    {% set th, tc, cfg     = p.toolhead, p.toolchanger, p.configfile.settings %}
    {% set ledvars         = p['gcode_macro _toolchanger_led_vars'] %}
    {% set colors          = ledvars.get('colors', {}).get('logo', {}) %}
    {% set brush_location  = ledvars.get('cache', {}).get('clean_location', False) %}


    {% set timeout_state = p.idle_timeout.state|lower %}
    {% set print_state   = p.print_stats.state|lower %}
    {% set webhook_state = p.webhooks.state|lower %}

    {% set tool         = p[tc.tool_names[param_tn|int]] %}
    {% set th_pos       = th.position %}
    {% set target_temp  = p[tool.extruder].target|float %}
    {% set live_pos         = p.motion_report.live_position %}
    #{% set _offs        = printer.gcode_move.homing_origin %}
    #{% set live_pos     = {'x': _pos[0] - _offs[0], 'y':_pos[1] - _offs[1], 'z':_pos[2] - _offs[2] } %}
    {% set current_vel  = p.motion_report.live_velocity %}
    {% set speed_factor = p.gcode_move.speed_factor %}

    {% set ns = namespace(status='ready', invert=False) %}
    {% set debug_enabled = param_tn|string in ledvars.get('debug', '')|string and param_idx|int == 0 %}
    {% set debug_lines = [] %}

    {%- macro debug_log(msg) -%}
        {% set _ = debug_lines.append(msg) if debug_enabled %}
    {%- endmacro -%}

    {%- macro main() -%}
        {% set flags = {
            'at_qgl_square':         False,
            'at_qgl_point':          False,
            'at_probing_speed':      False,
            'at_probing_lift_speed': False,
            'at_homing_speed':       False,
            'out_of_bounds':         False,
            'at_brush':              False,
            'tool_being_picked':     False,
            'tool_being_dropped':    False,
            'is_calibrating':        False
        } %}
        { set_flags(flags) }
        {% for k, v in flags.items() %}{ debug_log('flag ' ~ k ~ '=' ~ (v and '1' or '0')) }{% endfor %}
        { _decide_status(flags) }
        { debug_log('status raw=' ~ ns.status) }
        { debug_log('tn=' ~ param_tn ~ ' actn=' ~ ns.actn) }
        { _logo_apply_latch_and_cache(CACHE_KEY, ns.status, ns.invert) }
    {%- endmacro -%}

    {%- macro try_set_status(status, condition) -%}
        {% if status and condition %}
            {% if status|string in colors and (colors[status]|string|length >= 4 or colors[status] is mapping) %}
                {% set ns.status = status|string %}
            {% else %}
                { debug_log("missing '" ~ status ~ "' in _toolchanger_led_vars.colors, not setting") }
            {% endif %}
        {% endif %}
    {%- endmacro -%}

    {%- macro latch_delay(status, mode) -%}
        {% set latch_cfg       = ledvars.get('latch', {}).get('logo', {}) if ledvars.get('latch') is mapping else {} %}
        {% set latch_default   = latch_cfg.get('default', {}) if latch_cfg else {} %}
        {% set latch_enter_d   = latch_default.get('enter', 0.1)|float %}
        {% set latch_exit_d    = latch_default.get('exit', latch_enter_d)|float %}
        {% set key = status|string if status is not none else '' %}
        {% set cfg_l = latch_cfg.get(key, {}) if latch_cfg else {} %}
        { cfg_l.get('enter', latch_enter_d) if mode == 'enter' else cfg_l.get('exit', latch_exit_d) }
    {%- endmacro -%}

    {%- macro _logo_apply_latch_and_cache(cache_key, current_status, invert) -%}
        {% set lr              = SELF.last_run or {} %}
        {% set cache           = lr.get(cache_key, {}) %}
        {% set _cache          = cache.get(TOOL_NUMBER, {}) %}
        {% set now             = printer.toolhead.estimated_print_time %}
        {% set latched_status  = _cache.get('status', current_status) %}
        {% set pending_status  = _cache.get('pending_status', current_status) %}
        {% set pending_since   = _cache.get('pending_since', now) %}
        {% set pending_delay   = _cache.get('pending_delay', latch_delay(current_status, 'enter')|float) %}

        {% set current_enter_d = latch_delay(current_status, 'enter')|float %}
        {% set default_exit_d  = latch_delay(None, 'exit')|float %}
        {% set latched_exit_d  = latch_delay(latched_status, 'exit')|float if latched_status is not none else default_exit_d %}

        {% set latch_active    = (current_enter_d > 0.0) or (latched_exit_d > 0.0) %}
        {% if not latch_active %}
            {% set latched_status = current_status %}
            {% set pending_status = current_status %}
            {% set pending_since  = now %}
            {% set pending_delay  = 0.0 %}
        {% else %}
            {% set status_changed = (current_status != latched_status) %}

            {% if (not status_changed) or (pending_status != current_status) %}
                {% set target_delay = current_enter_d if not status_changed
                                      else [current_enter_d, latched_exit_d]|max %}
                {% set pending_status = current_status %}
                {% set pending_since  = now %}
                {% set pending_delay  = target_delay %}
            {% elif (now - pending_since) >= pending_delay %}
                {% set latched_status = pending_status %}
            {% endif %}
        {% endif %}

        {% set status_data = {
            'status':         latched_status,
            'raw_status':     current_status,
            'invert':         invert,
            'updated_at':     now,
            'pending_status': pending_status,
            'pending_since':  pending_since,
            'pending_delay':  pending_delay,
            'debug':          debug_lines,
            'debug_last_sent': _cache.get('debug_last_sent', 0.0)
        } %}

        {% set new_cache = cache.copy() %}
        {% set _ = new_cache.update({TOOL_NUMBER: status_data}) %}
        {% set _ = lr.update({CACHE_KEY: new_cache}) %}
        {% set _ = SELF.__setattr__('last_run', lr) %}
    {%- endmacro -%}

    {%- macro _decide_status(flags) -%}
        {% if ns.actn == TOOL_NUMBER %}
            {% if timeout_state == 'printing' %}
                { try_set_status('busy', True) }
            {% endif %}

            { try_set_status('printing',    print_state == 'printing') }
            { try_set_status('cleaning',    flags.at_brush) }
            { try_set_status('homing',      flags.at_homing_speed or flags.at_probing_speed or flags.out_of_bounds) }
            { try_set_status('leveling',    flags.at_qgl_square or flags.at_qgl_point) }
            { try_set_status('calibrating', flags.is_calibrating) }
            { try_set_status('printing',    print_state == 'printing' and p.print_stats.print_duration >= 300) }
            { try_set_status('changing',    tc.status == 'changing') }

            {% if ledvars.get('invert', False) %}
                {% set ns.invert = (flags.at_probing_speed or flags.at_qgl_point) and ns.status in ['leveling','homing'] %}
            {% else %}
                { try_set_status('probing',
                                ((flags.at_probing_speed or (flags.at_qgl_point and not flags.at_probing_lift_speed)))
                                and ns.status in ['leveling','homing']) }
            {% endif %}
            { try_set_status('paused', 'pause_resume' in p and p.pause_resume.is_paused) }
        {% else %}
            { try_set_status('busy',    target_temp|int != 0) }
            { try_set_status('changed', tc.status == 'changing' and flags.tool_being_picked) }
            { try_set_status('error',   tc.status == 'error'    and (flags.tool_being_picked or flags.tool_being_dropped)) }
        {% endif %}

        { try_set_status('idle', timeout_state == 'idle') }

        { try_set_status(ledvars.get('status', {}).get('logo', {}).get(TOOL_NUMBER, None), True) }
        { try_set_status('error', 'error' in webhook_state or 'shutdown' in webhook_state) }
    {%- endmacro -%}

    {%- macro set_flags(status_flags) -%}
        {%- macro set_flag(flag, condition) -%}
            {% set _ = status_flags.update({flag: True}) if condition %}
        {%- endmacro -%}

        {% if tc.has_detection %}
            {% set ns.actn = tc.detected_tool_number %}
            {% set probe_name = 'probe' if 'probe' in cfg else False %}
        {% elif 'tool_probe_endstop' in p %}
            {% set ns.actn = p.tool_probe_endstop.active_tool_number %}
            {% set probe_name = p.tool_probe_endstop.active_tool_probe %}
        {% else %}
            {% set ns.actn = tc.tool_number %}
        {% endif %}

        {% if (ns.actn is none or ns.actn|int < 0) and tc.status != 'changing' and tc.tool_number|int >= 0 %}
            {% set ns.actn = tc.tool_number %}
        {% endif %}

        {% if 'tools_calibrate' in p %}
            { set_flag('is_calibrating', not (p.tools_calibrate.calibration_probe_inactive or True)) }
        {% endif %}

        {% if probe_name and cfg[probe_name|lower]|select('in', ['speed', 'lift_speed'])|list|length == 2 %}
            { set_flag('at_probing_speed',
                    (current_vel - (cfg[probe_name|lower]['speed'] * speed_factor))|abs < vel_tol) }
            { set_flag('at_probing_lift_speed',
                    (current_vel - (cfg[probe_name|lower]['lift_speed'] * speed_factor))|abs < vel_tol
                    if cfg[probe_name|lower]['lift_speed'] != cfg[probe_name|lower]['speed'] else False) }
        {% endif %}

        { set_flag('out_of_bounds', th.homed_axes and 'z' not in th.homed_axes) }
        {% for axis in th.homed_axes if axis in ['x','y','z'] %}
            { set_flag('out_of_bounds',
                    (th_pos[axis] - cfg['stepper_' ~ axis].position_max)|abs < pos_tol or status_flags.out_of_bounds) }
        {% endfor %}

        {% if 'quad_gantry_level' in p %}
            {% set coords = {
                'x': cfg.quad_gantry_level.points|map(attribute=0)|list,
                'y': cfg.quad_gantry_level.points|map(attribute=1)|list
            } %}
            {% for ax, xa in [('x','y'), ('y','x')] if (live_pos[ax] - coords[ax]|min)|abs < pos_tol
                                                    or (live_pos[ax] - coords[ax]|max)|abs < pos_tol %}
                {% if (coords[xa]|min - pos_tol) <= live_pos[xa] <= (coords[xa]|max + pos_tol) %}
                    { set_flag('at_qgl_square', live_pos['z'] <= cfg.quad_gantry_level.horizontal_move_z + pos_tol) }
                {% endif %}
            {% endfor %}
            {% for pt in cfg.quad_gantry_level.points %}
                { set_flag('at_qgl_point',
                          (th_pos[0] - pt[0])|abs < pos_tol and (th_pos[1] - pt[1])|abs < pos_tol) }
            {% endfor %}
        {% endif %}

        {% for step in ['stepper_x','stepper_y','stepper_z'] %}
            {% for speed_name in ['homing_speed','homing_retract_speed','second_homing_speed'] if speed_name in cfg[step] %}
                { set_flag('at_homing_speed',  ((cfg[step][speed_name]) - current_vel)|abs < vel_tol) }
                { set_flag('at_probing_speed', ((cfg[step][speed_name]) - current_vel)|abs < vel_tol and 'z' in step) }
            {% endfor %}
        {% endfor %}

        {% for ax in ['x','y','z'] if brush_location and target_temp >= 100.0 %}
            { set_flag('at_brush',
                    (th_pos[ax] - brush_location[ax])|abs < (brush_tol if current_vel <= 10 else brush_tol * 2)) }
        {% endfor %}

        {% set tc_obj = p.printer.lookup_object('toolchanger', None) %}
        {% if tc_obj %}
            {% set ch_pick = tc_obj.__dict__.get('last_change_pickup_tool',  None) %}
            {% set ch_drop = tc_obj.__dict__.get('last_change_drop_tool',    None) %}
            {% set last_pick = ch_pick.__dict__.get('tool_number', -1) if ch_pick else -1 %}
            {% set last_drop = ch_drop.__dict__.get('tool_number', -1) if ch_drop else -1 %}
            { set_flag('tool_being_picked',  tc.status == 'changing' and TOOL_NUMBER == last_pick) }
            { set_flag('tool_being_dropped', tc.status == 'changing' and TOOL_NUMBER == last_drop) }
        {% endif %}
    {%- endmacro -%}

    { main() }

[display_template logo]
param_tn: 'None'
param_brightness: 1.0
param_idx: 0
param_max_idx: 0
text:
    {% if param_idx == 0 and param_tn == 0 and '_UPDATE_TOOL_UI' in printer.gcode.commands and printer.webhooks.state|lower != 'shutdown' %}
        {% set gcode_obj = printer.printer.lookup_object('gcode', None) %}  # hack
        {% set _ = gcode_obj.run_script_from_command('_UPDATE_TOOL_UI') if gcode_obj and gcode_obj is not none %}  # hack
    {% endif %}

    {% set p       = printer %}
    {% set ledvars = p['gcode_macro _toolchanger_led_vars'] %}
    {% set colors  = ledvars.get('colors', {}).get('logo', {}) %}
    {% set c       = {'r': 0, 'g': 0, 'b': 0, 'w': 0} %}
    {% set bright  = param_brightness|float %}
    {% set now     = p.toolhead.estimated_print_time %}
    {% set tn      = param_tn|int %}

    {%- macro apply_smoothing(rgbw_list=[]) -%}
        {%- set smoothed_rgbw = rgbw_list -%}
        {%- set smooth_time = ledvars.get('logo_smooth_fadetime', 0.0)|float(0.0) -%}
        {%- if smooth_time > 0 and 'display_template smooth_change' in p.configfile.settings -%}
            {%- set smoothed_rgbw = render('smooth_change',
                                    param_rgbw='%.4f, %.4f, %.4f, %.4f' % (base_rgbw[0], base_rgbw[1], base_rgbw[2], base_rgbw[3]),
                                    param_fadetime=smooth_time,
                                    param_identifier='logo_' ~ tn ~ '_' ~ param_idx,
                                    param_is_master=1 if param_idx|int == 0 else 0) -%}
            { smoothed_rgbw }
        {%- else -%}
            { rgbw_list|join(',') }
        {%- endif -%}
    {%- endmacro -%}

    {% if param_idx|int == 0 %}
        {% set _ = render('logo_status',
                          param_tn=param_tn,
                          param_idx=param_idx,
                          param_max_idx=param_max_idx) %}
    {% endif %}

    {% set templates        = p.printer.lookup_object('display_template').get_display_templates() %}
    {% set status_template  = templates.get('logo_status') %}
    {% set cache_map        = status_template.__dict__.get('last_run', {}).get('__logo_status_cache__', {}) if status_template else {} %}
    {% set cache            = cache_map.get(tn, {}) %}

    {% set status = cache.get('status', 'ready') %}
    {% set invert = cache.get('invert', False) %}
    {% set _dbg   = cache.get('debug', []) %}
    {% set debug_enabled = param_tn|string in ledvars.get('debug', '')|string %}
    {% set debug_last_sent = cache.get('debug_last_sent', 0.0)|float %}
    {% set should_emit_debug = debug_enabled and _dbg and param_idx|int == 0 and (now - debug_last_sent) >= 0.25 %}

    {% set status_color = colors.get(status, colors.get('ready', {})) %}

    {% if status_color is mapping %}
        {% set _ = c.update(status_color) %}
    {% elif status_color is string %}
        {% set tokens    = status_color.split() %}
        {% set tmpl_name = tokens[0] %}
        {% if 'display_template ' ~ tmpl_name not in p.configfile.settings %}
            {% set _ = _dbg.append('[display_template ' ~ tmpl_name ~ '] was not found in config.') %}
        {% else %}
            {% set render_parameters   = {} %}
            {% set possible_parameters = {
                'param_tn':       param_tn,
                'param_idx':      param_idx,
                'param_max_idx':  param_max_idx
            } %}
            {% for tk in tokens[1:] %}
                {% set kv = tk.split('=', 1) %}
                {% set _ = possible_parameters.update({'param_' ~ (kv[0]|replace('param_', ''))|trim: kv[1]|trim}) if kv|length == 2 else None %}
            {% endfor %}
            {% for k, v in possible_parameters.items() if k in p.configfile.settings['display_template ' ~ tmpl_name] %}
                {% set _ = render_parameters.update({k: v}) %}
            {% endfor %}
            {% set rgbw_list = (render(tmpl_name, **render_parameters)
                                |replace(' ', '')
                                |replace('\n', '')
                               ).split(',')|map('float', default=0.0)|list %}
            {% for rgbw in c.copy().keys() %}
                {% set _ = c.update({rgbw: rgbw_list[loop.index0]|default(0)}) %}
            {% endfor %}
        {% endif %}
    {% endif %}

    {% for k, v in c.copy().items() if invert %}{% set _ = c.update({k: (v - 1)|abs}) %}{% endfor %}

    {% set kv = c|dictsort(false, 'value')|last if c.r or c.g or c.b or c.w else [] %}
    {% if kv and kv[1] > 0 and ledvars.get('force_updates', False) and param_idx == param_max_idx %}
        {% set _ = c.update({kv[0]: c[kv[0]] + ((now/0.5 % 2) * 2 - 1) * 0.00392}) %}
    {% endif %}

    {% set base_rgbw = [c.r * bright, c.g * bright, c.b * bright, c.w * bright] %}

    {% set smoothed_rgbw = apply_smoothing(base_rgbw).split(',')|map('float', default=0.0)|list %}

    { render('_global_brightness_scalar', param_rgbw_list=smoothed_rgbw) }

    {% if should_emit_debug %}
        { action_respond_info(_dbg|join('\n')) }
        {% if cache %}
            {% set _ = cache.update({'debug_last_sent': now}) %}
            {% set _ = cache_map.update({tn: cache}) if cache_map %}
        {% endif %}
    {% endif %}

#---------------------------------< Thermal, interpolating between min and max for provided tn
[display_template nozzle]
param_tn: 'None'
param_idx: 0
param_brightness: 1.0
param_min_temp: 50
param_max_temp: 160
text:
    {% set max_t = param_max_temp|float %}
    {% set min_t = param_min_temp|float %}
    #--- Short-form variables ---
    {% set p       = printer %}
    {% set cfg     = p.configfile.settings %}
    {% set tc      = p.toolchanger %}
    {% set ledvars = p['gcode_macro _toolchanger_led_vars'] %}
    {% set colors  = ledvars.get('colors', {}).get('nozzle', {}) %}
    {% set c       = {'r':0, 'g':0, 'b':0, 'w':0} %}
    {% set bright  = param_brightness|float %}
    {% set rend_pa = {} %}

    # ---< get temps etc
    {% set e_name    = cfg[tc.tool_names[param_tn|int]|lower].extruder %}
    {% set cur_t     = p[e_name].temperature|float %}
    {% set tar_t     = p[e_name].target|float %}
    {% set is_active = (param_tn|int == tc.tool_number|int) %}

    # ---< determine the status
    {% set status = ledvars.get('status', {}).get('nozzle', {}).get(param_tn|int, 'thermal') %}
    {% if status == 'thermal' %}
        {% if is_active %}
            {% set status = 'on' %}
        {% else %}
            {% set status = 'ready' if tar_t == 0 and cur_t <= min_t else status %}
        {% endif %}
    {% endif %}

    # ---< get the setting for that status
    {% set status_color = colors.get(status, None) %}

    {% if status == 'thermal' %}
        {% set c_cold = colors.get('cold', {'r':0.0, 'g':0.0, 'b':1.0, 'w':0.0}) %}
        {% set c_hot  = colors.get('hot',  {'r':1.0, 'g':0.0, 'b':0.0, 'w':0.0}) %}
        {% set scalar = [ [ 0.0, (cur_t - min_t) / ([ (max_t - min_t)|abs, 0.01 ]|max) ]|max, 1.0 ]|min %}
        {% for k in c %}
            {% set _ = c.update({k: c_cold[k] + (c_hot[k] - c_cold[k]) * scalar }) %}
        {% endfor %}

    # ---< get the status colors if its colors.
    {% elif status_color is mapping %}
        {% set _ = c.update(status_color) %}

    # ---< if its a template, render it instead.
    {% elif status_color is string and 'display_template ' ~ status_color in cfg %}
        # ---< add possible parameters.
        {% set pos_params = {'param_tn': param_tn, 'param_idx': param_idx} %}
        {% for k, v in pos_params.items() if k in cfg['display_template ' ~ status_color] %}
            {% set _ = rend_pa.update({k: v}) %}
        {% endfor %}
        # ---< render template
        {% set rgbw_list = render(status_color, **rend_pa).split(',')|map('float', default=0.0)|list %}
        {% if rgbw_list|length == 4 %}
            {% set _ = c.update({'r': rgbw_list[0], 'g': rgbw_list[1], 'b': rgbw_list[2], 'w': rgbw_list[3]}) %}
        {% endif %}
    {% endif %}

    # ---< Apply brightness scaling for this led, also flicker randomly to force updates.
    {% set kv = c|dictsort(false, 'value')|last if c.r or c.g or c.b or c.w else [] %}
    {% if kv and kv[1] > 0 %}
        {% set tick = (p.toolhead.estimated_print_time)|int %}
        {% set flicker = ((tick % 2) * 2 - 1) * 0.004 %}
        {% set _ = c.update({kv[0]: c[kv[0]] + flicker}) %}
    {% endif %}

    { render('_global_brightness_scalar', param_rgbw_list=[c.r * bright, c.g * bright, c.b * bright, c.w * bright]) }

[display_template smooth_change] # smooth RGBW changes over time, please for the love of god provide a unique identifier per LED 
param_fadetime: 5.0
param_rgbw: "0.00, 0.00, 0.00, 0.00"
param_identifier: "smooth_change"
param_is_master: 0
text:
    {%- macro clamp(val, lo, hi) -%}{ [[val, lo]|max, hi]|min }{%- endmacro -%}

    {%- set _p          = printer.printer -%}
    {%- set templates   = _p.lookup_object('display_template').get_display_templates() -%}
    {%- set SELF        = templates.get('smooth_change') -%}
    {%- set last_run    = SELF.last_run or {} -%}
    {%- set shared_key  = '__smooth_change_shared__' -%}
    {%- set shared      = last_run.get(shared_key) -%}
    {%- set master      = param_is_master|int(0) -%}

    {%- if master or shared is none -%}
        {%- set now     = printer.toolhead.estimated_print_time -%}
        {%- set shared  = {'now': now} -%}
        {%- set _       = last_run.update({shared_key: shared}) -%}
    {%- else -%}
        {%- set now     = shared.get('now') -%}
    {%- endif -%}

    {%- set identifier  = (param_identifier|string) -%}
    {%- set target      = (param_rgbw|string).split(',')|map('trim')|map('float')|list -%}
    {%- set target      = (target + [0.0, 0.0, 0.0, 0.0])[:4] -%}

    {%- set state       = last_run.get(identifier, {}) -%}
    {%- set prev_rgbw   = state.get('rgbw', target) -%}
    {%- set prev_rgbw   = prev_rgbw[:4] -%}

    {%- set previous    = state.get('previous', now) -%}
    {%- set dt          = (now - previous) if (now >= previous) else 0.0 -%}

    {%- set T           = (param_fadetime|float(5.0)) -%}
    {%- set max_step    = dt / [0.000001, T]|max -%}

    {%- set step_r      = clamp(target[0] - prev_rgbw[0], -max_step, max_step)|float -%}
    {%- set step_g      = clamp(target[1] - prev_rgbw[1], -max_step, max_step)|float -%}
    {%- set step_b      = clamp(target[2] - prev_rgbw[2], -max_step, max_step)|float -%}
    {%- set step_w      = clamp(target[3] - prev_rgbw[3], -max_step, max_step)|float -%}

    {%- set r           = (prev_rgbw[0] + step_r) -%}
    {%- set g           = (prev_rgbw[1] + step_g) -%}
    {%- set b           = (prev_rgbw[2] + step_b) -%}
    {%- set w           = (prev_rgbw[3] + step_w) -%}

    {%- set new_state   = {'previous': now, 'rgbw': [r, g, b, w]} -%}
    {%- set _           = last_run.update({identifier: new_state}) -%}
    {%- set _           = SELF.__setattr__('last_run', last_run) -%}

    { '%.4f, %.4f, %.4f, %.4f' % (r, g, b, w) }


# ---< automatically loads brush location if it finds it.
[delayed_gcode _LOAD_CLEAN_NOZZLE_LOCATION]
initial_duration: 0.1
gcode:
  {% set var_cache = printer['gcode_macro _toolchanger_led_vars'].cache %}
  {% if var_cache.get('clean_location', None) is none and printer.motion_report.live_velocity <= 0.001 %}
    {% set cache, _cache = {}, {} %}
    {% for stuff in printer if 'gcode_macro ' in stuff and not cache.values()|select|list %}
      {% if 'clean' in stuff|lower and 'nozzle' in stuff|lower %}
        {% for s in ['_', ''] if not cache.keys()|select|list %}
          {% set _ = _cache.clear() %}
          {% for k, v in printer[stuff].items() if k[s|length-1:] in [s ~ 'x', s ~ 'y', s ~ 'z'] and (v|string).isnumeric() %}
            {% set _ = _cache.update({k[-1] : v|float}) %}
          {% endfor %}
        {% set _ = cache.update(_cache, name=stuff) if _cache.values()|list|length == 3 else None %}
      {% endfor %}
      {% endif %}
    {% endfor %}
    {% set _ = var_cache.update({'clean_location': (False if cache.keys()|list|length != 4 else _cache)}) %}
    SET_GCODE_VARIABLE MACRO=_toolchanger_led_vars VARIABLE=cache VALUE="{var_cache}"
    #{action_respond_info("brush found at '" ~ _cache|string|replace('{','')|replace('}','')|replace("'",'') ~ "', is that correct?")}
  {% else %}
    UPDATE_DELAYED_GCODE ID=_LOAD_CLEAN_NOZZLE_LOCATION DURATION=1
  {% endif %}
