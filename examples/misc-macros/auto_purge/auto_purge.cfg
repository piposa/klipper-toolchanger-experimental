

[gcode_macro AUTO_PURGE]
variable_purge_settings: {
        'z':                 0.30, # line height
        'line_width':        1.20, # of the purge lines
        'flow_rate':         25.0, # in mm³/s
        'prime_volume':      25.0, # in mm³
        'flow':              0.95, # flowrate multiplier

        'z_hop':             0.2,  # while traveling between them
        'travel_speed':      700,  # mm/s
        'initial_t_retract': 0.1,  # retract on the tool thats going to be first on the print
        'other_t_retract':   0.3,  # retract on all the other ones that get stashed

        'line_spacing':      1.5,  # between indivdual purge lines
        'purge_offset':      2.0,  # from object to first line
        
        'use_gcode_analysis': 1,   # 0 -> use exclude_object polygons | 1 -> parse gcode file for footprint
        #'gcode_path':        'AntHead_Assembly v43_Open_Grill v4 v1_ABS_10m42s.gcode',
        #'debug_trace':       1     # 0 -> Silent | 1 -> Print timing and debug info
    }
variable_svg_settings: {
        'box_pad': 5.0,
        'max_size': 200,
        'line_thickness': 1.2
    }
variable_poly_tools_settings: {
        'gcode_line_width': 0.6, # set to 1.5x your usual max line width
        'lib_path':   '~/printer_data/config/toolchanger/auto_purge',
        'resolution':  0.25, # increase if TTC, decrease if you need finer granularity
    }
gcode:
    {% set SELF = 'AUTO_PURGE' %}

    {%- macro _prep_lib(path='') -%}
        {%- set os = import('os') -%}
        {%- set path = os.path.expanduser(path) if path -%}
        {%- set _ = action_raise_error('Path for poly tools lib not found (' ~ path ~ ')') 
                    if not path or not os.path.exists(path) -%}
        {%- set _ = sys.path.append(path) if path not in sys.path -%}
        { 'poly_tools' }
    {%- endmacro -%}

    {% set pp        = printer.printer %}
    {% set importlib = pp.__class__.__init__.__globals__.importlib %}
    {% set import    = importlib.import_module %}
    {% set time      = import('time') %}
    {% set sys       = import('sys') %}
    {% set poly      = import(_prep_lib(poly_tools_settings.lib_path)) %}
    {%- set _        = importlib.reload(poly) -%}

    {% set ps =  purge_settings %}
    {% set pts = poly_tools_settings %}

    {% set tprof = namespace(start=time.time(), last=time.time(), idx=0) %}
    {% macro tmark(label='') %}
        {% if ps.debug_trace %}
            {% set now   = time.time() %}
            {% set dt    = (now - tprof.last) * 1000.0 %}
            {% set total = (now - tprof.start) * 1000.0 %}
            {% set tprof.idx  = tprof.idx + 1 %}
            {% set tprof.last = now %}

            { action_respond_info(
                SELF ~ " timing[t" ~ tprof.idx ~ "] "
                ~ (label or 'mark')
                ~ "  +" ~ ("%.1f" % dt) ~ "ms"
                ~ "  total=" ~ ("%.1f" % total) ~ "ms"
            ) }
        {% endif %}
    {% endmacro %}

    {% set th               = printer.toolhead %}
    {% set bed_max, bed_min = th.axis_maximum, th.axis_minimum %}
    {% set bed_center_x     = bed_min.x + (bed_max.x - bed_min.x) / 2.0 %}
    {% set bed_center_y     = bed_min.y + (bed_max.y - bed_min.y) / 2.0 %}
    {% set X                = params.X|default(params.POS_X)|default(bed_center_x)|float %}
    {% set Y                = params.Y|default(params.POS_Y)|default(bed_center_y)|float %}

    {% macro main() %}
        
        {% if ps.use_gcode_analysis|int == 1 %}
            {% set _target, objects = [], [] %}
            { prepare_objects_from_gcode(objects, _target) }
            {% set X, Y = _target if _target else (X, Y) %}
        {% endif %}

        {% set objects = printer.exclude_object.objects if not objects else objects %}

        {% if objects %}
            {% set _polys = objects|selectattr('polygon', 'defined')|map(attribute='polygon')|list %}

            {% for obj in objects %}
                 {% set dist = poly.get_polygon_distance_to_point(obj.polygon, [X, Y]) %}
                 {% set _ = obj.update({'distance': dist or 999999.9}) %}
            {% endfor %}
        
            {%- set line_len = et.mm_path_from_volume(volume=ps.prime_volume,
                                                      width=ps.line_width,
                                                      height=ps.z,
                                                      flow=ps.flow)|float -%}

            {% set tools_raw = parse_print_start(parameters=params) %}
            {% set tools     = [] if not tools_raw else tools_raw.split(',')|map('int')|list %}
            {% set num_lines = (tools|length) if tools else 5 %}
            {% set spacing   = [ps.line_spacing|float, ps.line_width|float]|max %}
            {% set clearance = ps.purge_offset|float %}
            {% set max_offset = clearance  + (num_lines - 1) * spacing + 0.5 * ps.line_width %}

            { tmark('before find poly') }
            {% set best_obj = objects|min(attribute='distance') %}
            # recursively merges objects into target object until line has no collisions, returns ccw or cw winding order if successfull
            {% set winding = _find_purge_line_poly(target_object=best_obj,
                                                   obstacles=objects,
                                                   offset_base=max_offset,
                                                   clearance_other=clearance,
                                                   line_length=line_len, target=[X, Y]) %}
            { tmark('after find poly') }

            {% set lines = [] %}
            {% for idx in range(num_lines) if winding|trim -%}
                {% set offset = clearance + idx * spacing %}
                {% set off_polys = poly.offset_polygon(best_obj.polygon,
                                                       offset, resolution=pts.resolution) %}
                {% if off_polys %}
                    {% set line = poly.get_polyline_segment(off_polys|first, [X, Y], line_len, winding|trim) %}
                    {% set _ = lines.append(line) if line %}
                {% endif %}
            {% endfor %}

            { print_svg(polygons=_polys, lines=lines, target=[X, Y]) }
            { tmark('after svg') }
            
            {% if tools %}
                { msg('purging tool(s): ' ~ tools_raw) }
                { print_lines_ordered(lines=lines, tools=tools,
                                      height=ps.z, width=ps.line_width, hop=ps.z_hop,
                                      flow=ps.flow, flowrate=ps.flow_rate,
                                      move_speed=ps.travel_speed) }
            {% endif %}
        {% endif %}  
    {% endmacro %}

    {%- macro _find_purge_line_poly(target_object, obstacles,
                                    offset_base=0.0, clearance_other=0.0,
                                    line_length=0.0, target=(0, 0)) -%}

        {%- for obj in obstacles if 'polygon' in obj -%}
            {%- set _offs = poly.offset_polygon_geometric(obj.polygon, clearance_other) -%}
            {%- set _ = obj.update({'clearance': _offs if _offs else obj.polygon}) -%}
        {%- endfor -%}

        {%- macro __loop__(target_object, obstacles, offset_base, line_length, target) -%}
            {%- set hull_offset = poly.offset_polygon_geometric(target_object.polygon, offset_base) -%}
            {%- set hit = {'ccw': -1, 'cw': -1} -%}
            # dont run cw if ccw was already clear
            {%- for direction in ['ccw', 'cw'] if not (direction == 'cw' and hit.ccw < 0) -%}
                {%- set cand = poly.get_polyline_segment(hull_offset, target, line_length, direction) -%}
                {%- if cand -%}
                    {%- for i in range(obstacles|length) if hit[direction] < 0 -%}
                        {%- set other = obstacles[i] -%}
                        {%- for pt in cand if hit[direction] < 0 -%}
                            {%- set _ = hit.update({direction: i}) if poly.point_in_polygon(other.clearance, pt) -%}
                        {%- endfor -%}
                    {%- endfor -%}
                {%- else -%}
                    # something went wrong, force merge/retry
                    {%- set _ = hit.update({direction: 0}) if obstacles|length > 0 -%}
                {%- endif -%}
            {%- endfor -%}

            {%- if hit.ccw < 0 -%}
                { 'ccw' }
            {%- elif hit.cw < 0 -%}
                { 'cw' }
            {%- else -%}
                # recurse
                {%- set other = obstacles.pop(hit.ccw) -%}
                { tmark('hit ' ~ other.name ~ ', merging') }
                {%- set _ = target_object.update({
                        'polygon': poly.get_convex_hull([target_object.polygon, other.polygon])
                    }) -%}
                {- __loop__(target_object, obstacles, offset_base, line_length, target) -}
            {%- endif -%}
        {%- endmacro -%}
        {- __loop__(target_object, obstacles, offset_base, line_length, target) -}
    {%- endmacro -%}

    {% macro print_lines_ordered(lines=[], tools=[],
                                height=0.3, width=None,
                                hop=0.0,
                                flow=1.0, flowrate=5.0,
                                move_speed=100) %}
        SAVE_GCODE_STATE NAME=_AUTO_PURGE

        {% set ps = purge_settings %}
        {% set Fmove = (move_speed*60)|float %}
        {% set lines = lines|reverse|list %}
        {% set n = [lines|length, tools|length]|min %}

        {% for i in range(n) %}
            {% set line = lines[i] %}
            {% set x, y, z = line[0][0], line[0][1], height %}
            {% set z_travel = (z + hop)|round(3) %}
            {% set cur_tool = tools[i] %}
            {% set extr = 'extruder' if cur_tool <= 0 else 'extruder' ~ cur_tool %}

            T{ cur_tool } X={ x|round(3) } Y={ y|round(3) } Z={ z_travel|round(3) }
            G0 Z{ z_travel } F{Fmove}
            G0 X{ x|round(3) } Y{ y|round(3) }
            G0 Z{ z|round(3) }
            {% if loop.next %}M104 S{ params['T' ~ tools[i + 1] ~ '_TEMP']|default(params['TOOL_TEMP']|default(220))|int - 25 }{% endif %}
            M109 S{ params['T' ~ cur_tool ~ '_TEMP']|default(params['TOOL_TEMP']|default(220)) }

            { mt.print_line(line=line,
                            width=width, height=height,
                            extruder=extr,
                            flow=flow, flowrate=flowrate) }

            {% if loop.last %}
                {% if ps.initial_t_retract %}G1 E{ -ps.initial_t_retract } F{50*60}{% endif %}
            {% else %}
                {% if ps.other_t_retract %}G1 E{ -ps.other_t_retract } F{50*60}{% endif %}  
            {% endif %}
            G0 Z{ z_travel } F{Fmove}
        {% endfor %}
        RESTORE_GCODE_STATE NAME=_AUTO_PURGE MOVE=0
        TC_LOAD_OFFSETS
    {% endmacro %}

    {% macro prepare_objects_from_gcode(objects=[], target=[]) %}
            { tmark('starting gcode analysis') }
            {% set fpath = ps.gcode_path or printer.print_stats.filename %}
            {% set fpath = (printer.configfile.settings.virtual_sdcard.path ~ '/' ~ fpath) 
                            if not fpath[0] in ['/', '~'] else fpath %}
            {% set z_first = poly.find_first_layer_z(fpath, threshold=1.0) %}
            {% if z_first %}
                {% set segs = poly.parse_gcode_data(fpath, z_first) %}
                {% if segs %}
                    {% set lines = [] %}
                    {% for seg in segs %}
                        {% set line = [] %}
                        {% for p in seg %}{% set _ = line.append([p.x, p.y]) %}{% endfor %}
                        {% set _ = lines.append(line) if line|length > 1 %}
                    {% endfor %}
                    {% set _res = pts.resolution %}
                    {% set np_grid, origin = poly.rasterize_lines(lines, resolution=_res, line_width=pts.gcode_line_width or 1.0) %}
                    {% set contours = poly.raster_outline(np_grid, _res, origin, filter_holes=True,
                                                          simplify_tol=_res, min_area=10.0) %}
                    {% for cont in contours %}
                        {% set _ = objects.append({'polygon': cont, 'name': 'gcode_part_' ~ loop.index}) %}
                    {% endfor %}
                    {% set _ = target.append(segs[0][0].x) %}
                    {% set _ = target.append(segs[0][0].y) %}
                    { tmark('gcode analysis done, parsed: ' ~ objects|length ~ ' objects') }
                {% endif %}
            {% else %}
                 { err('Gcode analysis failed: no first layer found.') }
            {% endif %}
    {% endmacro %}

    {%- macro parse_print_start(parameters=params) -%}
        {%- set cur = printer.toolchanger.tool_number -%}
        {%- set init_raw = parameters.get('INITIAL_TOOL',
                                        parameters.get('TOOL', cur))|string -%}
        {%- set init = init_raw|replace('T', '')|int -%}
        {%- set tools = [] -%}
        {%- for tn in printer.toolchanger.tool_numbers if ('T' ~ tn ~ '_TEMP') in parameters -%}
            {%- set _ = tools.append(tn) if tn not in tools -%}
        {%- endfor -%}
        {%- if cur in tools and cur != init -%}
            {%- set _ = tools.remove(cur) -%}
            {%- set _ = tools.insert(0, cur) -%}
        {%- endif -%}
        {%- if init in tools -%}
            {%- set _ = tools.remove(init) -%}
            {%- set _ = tools.append(init) -%}
        {%- endif -%}
        { tools|join(',') }
    {%- endmacro -%}

    #-------------------- SVG ----------------------------------------------------------
    {% macro print_svg(polygons=[], lines=[], extra='', target=(175,175)) %}
        {% set _svg_tools  = pp.lookup_object('gcode_macro _SVG_TOOLS', None) %}
        {% if not polygons and not lines %}
            { action_respond_info('cant show SVG, no lines and no polys to display.') }
        {% elif not _svg_tools %}
            { action_respond_info('cant show SVG, svg tools missing/not found.') }
        {% else %}
            { parse_settings(params, svg_settings) }
            {% import _svg_tools.template.template as svg with context %}
            {%- set parts = [] -%}
            {% macro _add(part) %}{% set _ = parts.append(part) %}{% endmacro %}

            { _add( svg.rectangle(0, 0, bed_max.x, bed_max.y, stroke_color="var(--p-border)", stroke_width=0.5, fill="var(--p-background-darker)") ) }
            { _add( svg.draw_ticks(0, 0, bed_max.x, bed_max.y, size=12, stroke_color='var(--p-text-color, grey)', stroke_width=1.0, angle=0.0, linecap='butt') ) }

            {%- for _poly in polygons -%}
                { _add(svg.polygon(points=_poly)) }
            {%- endfor -%}

            {%- for _line in lines -%}
                { _add(svg.polyline(points=_line,
                                    stroke_color=svg.random_color(alpha=0.7),
                                    stroke_width=svg_settings.line_thickness or 0.6)) }
            {%- endfor -%}

            { _add(svg.crosshair(target[0], target[1], stroke_color="var(--p-text-color, light-grey)" , size=4.0, stroke_width=1.0) ) }
            {%- set svg_out = svg.canvas(w=bed_max.x, h=(-1 * bed_max.y), content=parts|join ~ extra, pad=10, max_size=400) -%}
            { action_respond_info(svg_out) }
        {% endif %}
    {% endmacro %}

    {% macro parse_settings(parameters={}, settings={}) %}
        {% for parameter in parameters if parameter|lower in settings %}
            {% set new_value = parameters.get(parameter, None)|float(None) %}
            {% if new_value is not none %}
                {% set _ = settings.update({parameter|lower: new_value}) %}
            {% else %}
                { action_respond_info("invalid settings value for [" ~ parameter ~ "]: '" ~ 
                                    parameters.get(parameter) ~ "', needs to be of type 'float'") }
            {% endif %}
        {% endfor %}
    {% endmacro %}

    {% macro msg(s, prefix_color="--v-accent-base, orange", msg_color="--p-text-color2, grey") %}
        {% set desc = printer.configfile.settings['gcode_macro ' ~ SELF|lower].description|e %}
        {% set pre  = "<span style=\"color: var(" ~ prefix_color ~ "); font-weight:bold;\" title=\"" ~ desc ~ "\">" ~ SELF ~ " </span>" %}
        { action_respond_info(pre ~ "<span style=\"color: var(" ~ msg_color ~ ");\" title=\"" ~ desc ~ "\">" ~ s ~ "</span>") }
    {% endmacro %}
    {% macro err(s) %}{ msg(s, prefix_color="--v-error-base, red", msg_color="--v-warning-base, orange") }{% endmacro %}

    {%- set _et_lib = pp.lookup_object('gcode_macro _EXTRUSION_TOOLS', None) -%}
    {%- set _mt_lib = pp.lookup_object('gcode_macro _MOTION_TOOLS', None) -%}
    {% set _ = action_raise_error('Missing library: _EXTRUSION_TOOLS') if not _et_lib %}
    {% set _ = action_raise_error('Missing library: _MOTION_TOOLS') if not _mt_lib %}

    {% import _et_lib.template.template as et with context %}
    {% import _mt_lib.template.template as mt with context %}

    { parse_settings(params, purge_settings) }

    { main() }

[gcode_macro _SVG_TOOLS]
gcode:
    {% set _ = missing_context_please_import_with_context_or_define_printer() if not printer %}
    {%- set gbl  = printer.printer.__class__.__init__.__globals__ -%}
    {%- set math = gbl.importlib.import_module('math') -%}

    {%- macro canvas(w, h, content, pad=0.0, max_size=400, interactive=True) -%}
        # width, height negative to flip SVG
        {%- set s =
            '<div class="svg_click_open" ' ~
            ('title="Click to open" ' if interactive else '') ~
            'style="max-inline-size:' ~ max_size ~ 'px; ' ~
                'max-block-size:' ~ max_size ~ 'px; ' ~
                'inline-size:100%; cursor:zoom-in;">'
        -%}

        {%- set s = s ~
            '<div style="' ~
                'inline-size:100%; ' ~
                'aspect-ratio:1/1;' ~
            '">'
        -%}
        {%- set abs_w, abs_h = w|abs, h|abs -%}
        {%- set view_w, view_h = abs_w + (pad*2), abs_h + (pad*2) -%}
        {%- set s = s ~
            '<svg xmlns="http://www.w3.org/2000/svg" ' ~
                'viewBox="' ~ -pad ~ ' ' ~ -pad ~ ' ' ~ view_w ~ ' ' ~ view_h ~ '" ' ~
                'preserveAspectRatio="xMidYMid meet" ' ~
                'style="display:block;inline-size:100%;block-size:100%;">'
        -%}
        {%- set flip_x, flip_y = w < 0, h < 0 -%}
        {%- if flip_x or flip_y -%}
            {%- set s = s ~ 
            '<g transform="' ~
                'translate(' ~ (abs_w if flip_x else 0) ~ ', ' ~ (abs_h if flip_y else 0) ~ ')' ~
                'scale('     ~ (-1   if flip_x else 1) ~ ', ' ~ (-1   if flip_y else 1) ~ ')">'
            -%}
        {%- endif -%}
        {%- set s = s ~ content -%}
        {%- set s = s ~ ('</g>' if flip_x or flip_y else '') -%}
        {%- set s = s ~ '</svg>' -%}
        {%- set s = s ~ (interactive_js(*vaargs, **kwargs) if interactive else '') -%}
        {%- set s = s ~ '</div></div>' -%}
        { s }
    {%- endmacro -%}

    {%- macro rectangle(x, y, w, h, stroke_color="var(--p-border, black)", stroke_width=1, fill="none") -%}
        # Draws a generic rectangle.
        { '<rect x="' ~ x|round(3) ~ '" y="' ~ y|round(3) ~ '" width="' ~ w|round(3) ~ '" height="' ~ h|round(3) ~
          '" fill="' ~ fill ~ '" stroke="' ~ stroke_color ~ '" stroke-width="' ~ stroke_width|round(3) ~
          '" vector-effect="non-scaling-stroke" />' }
    {%- endmacro -%}
    
    {%- macro draw_ticks(x, y, w, h, size=12, stroke_color='var(--p-text-color, grey)', stroke_width=1.0, angle=0.0, linecap='butt') -%}
        {%- set r        = angle * math.pi / 180.0 -%}
        {%- set u1x, u1y = math.cos(r), math.sin(r) -%}
        {%- set center_x, center_y  = x + w / 2.0, y + h / 2.0 -%}
        {%- set points = [
            (x, y),     (x, y + h),
            (x + w, y), (x + w, y + h)
        ] -%}
        {%- set segs = [] -%} # segs uwu
        {%- for px, py in points -%}
            {%- set vx, vy = center_x - px, center_y - py -%}
            {%- set s1 = 1 if (vx *  u1x + vy * u1y) >= 0 else -1 -%}
            {%- set s2 = 1 if (vx * -u1y + vy * u1x) >= 0 else -1 -%}
            {%- set _ = segs.append('M ' ~ px ~ ' ' ~ py ~ ' l ' ~ (s1 * size *  u1x) ~ ' ' ~ (s1 * size * u1y)) -%}
            {%- set _ = segs.append('M ' ~ px ~ ' ' ~ py ~ ' l ' ~ (s2 * size * -u1y) ~ ' ' ~ (s2 * size * u1x)) -%}
        {%- endfor -%}
        { '<path d="' ~ segs|join(' ') ~ '" fill="none" stroke="' ~ stroke_color ~
        '" stroke-width="' ~ stroke_width ~ '" stroke-linecap="' ~ linecap ~
        '" vector-effect="non-scaling-stroke" />' }
    {%- endmacro -%}

    {%- macro polygon(points, stroke_color='var(--p-text-color2, white)', stroke_width=1, fill_color=random_color(alpha=0.7)) -%}
        {%- set pts = points|map('join',',')|join(' ') -%}
        { '<polygon points="' ~ pts ~ '" stroke="' ~ stroke_color ~ '" fill="' ~ 
            fill_color ~ '" stroke-width="' ~ stroke_width ~ '" />' }
    {%- endmacro -%}

    {%- macro polyline(points, stroke_color=random_color(alpha=0.7), stroke_width=0.6) -%}
        {%- set pts = points|map('join',',')|join(' ') -%} # join
        { '<polyline points="' ~ pts ~ '" stroke="' ~ stroke_color ~ 
            '" fill="none" stroke-width="' ~ stroke_width ~ 
            '" stroke-linecap="round" stroke-linejoin="round" />' }
    {%- endmacro -%}

    {%- macro crosshair(x, y, stroke_color="var(--p-text-color, light-grey)" , size=4.0, stroke_width=1.0) -%}
        { polyline([[x-size,y],[x+size,y]], stroke_color, stroke_width) ~
          polyline([[x,y-size],[x,y+size]], stroke_color, stroke_width) }
    {%- endmacro -%}

    {%- macro random_color(alpha=None, h_min=0, h_max=3600, s_min=550, s_max=850, v_min=700, v_max=950) -%}
        {%- set h = (range(h_min, h_max)|random) / 10.0 -%}
        {%- set s = (range(s_min, s_max + 1)|random) / 1000.0 -%}
        {%- set v = (range(v_min, v_max + 1)|random) / 1000.0 -%}
        {%- set r, g, b = hsv_to_rgb(h, s, v).split(',')|map('int') -%}
        {%- if alpha -%}
            { 'rgba(' ~ r ~ ',' ~ g ~ ',' ~ b ~ ',' ~ alpha ~ ')' }
        {%- else -%}
            { 'rgb(' ~ r ~ ',' ~ g ~ ',' ~ b ~ ')' }
        {%- endif -%}
    {%- endmacro -%}

    {%- macro hsv_to_rgb(h, s, v) -%}
        {%- set h = h % 360.0 -%}
        {%- set i = (h // 60)|int -%}
        {%- set f = (h / 60.0) - i -%}
        {%- set p = v * (1.0 - s) -%}
        {%- set q = v * (1.0 - s * f) -%}
        {%- set t = v * (1.0 - s * (1.0 - f)) -%}
        {%- set rgb_map = [
            [v, t, p],
            [q, v, p],
            [p, v, t],
            [p, q, v],
            [t, p, v],
            [v, p, q]
        ] -%}
        {%- set r = (rgb_map[i % 6][0] * 255)|round|int -%}
        {%- set g = (rgb_map[i % 6][1] * 255)|round|int -%}
        {%- set b = (rgb_map[i % 6][2] * 255)|round|int -%}
        { r ~ ',' ~ g ~ ',' ~ b }
    {%- endmacro -%}

    {%- macro interactive_js(label='svg_click_open', initial_zoom=None) -%}
        {%- set js %}{%- raw -%}
        (function(img){
        try{
            var box = img.closest('.{%- endraw -%}{label}{%- raw -%}');
            if (box==null){ img.remove(); return; }
            if (box.dataset && box.dataset.bound){ img.remove(); return; }
            box.dataset.bound='1';

            var theme = box.closest('.theme--dark') || document.body;

            function copyAllCustomProps(fromEl,toEl){
            try{
                var cs = getComputedStyle(fromEl);
                for (var i=0;i<cs.length;i++){
                var name = cs[i];
                if (name && name.indexOf('--')===0){
                    var v = cs.getPropertyValue(name);
                    if (v){ toEl.style.setProperty(name, v.trim()); }
                }
                }
            }catch(e){}
            }

            box.addEventListener('click', function(){
            try{
                var s = box.querySelector('svg'); if (s==null) return;

                var vb = s.viewBox && s.viewBox.baseVal ? s.viewBox.baseVal : null;
                var vw0 = vb ? vb.width  : 1000;
                var vh0 = vb ? vb.height : 1000;

                var clone = s.cloneNode(true);
                clone.removeAttribute('style');
                clone.setAttribute('style','display:block;width:100%;height:100%');

                var panel = document.createElement('div');
                panel.setAttribute('style',
                    'position:absolute;left:0;top:0;' +
                    'display:flex;align-items:center;justify-content:center;' +
                    'transform-origin:0 0;cursor:auto;'
                );
                copyAllCustomProps(theme, panel);
                panel.appendChild(clone);

                var ov = document.createElement('div');
                ov.setAttribute('style',
                    'position:fixed;left:0;top:0;right:0;bottom:0;' +
                    'background:transparent;overflow:hidden;' +
                    'z-index:99999;cursor:zoom-out;'
                );
                copyAllCustomProps(theme, ov);

                function fitScale(){
                    var w = window.innerWidth, h = window.innerHeight;
                    var k = Math.min(w*0.95/vw0, h*0.95/vh0);
                    if (!(k>0)) k = 1;
                    return k;
                }
                var initialZoom = parseFloat(box.dataset.initialZoom);
                var k = (initialZoom > 0) ? initialZoom : fitScale();

                var tx = Math.floor((window.innerWidth  - vw0*k)/2);
                var ty = Math.floor((window.innerHeight - vh0*k)/2);

                function apply(){
                    panel.style.transform = 'translate(' + tx + 'px,' + ty + 'px) scale(' + k + ')';
                    panel.style.width  = vw0 + 'px';
                    panel.style.height = vh0 + 'px';
                }
                apply();

                var dragging=false, lastX=0, lastY=0;

                panel.addEventListener('mousedown', function(ev){
                try{
                    if (ev.button===0){
                    dragging=true; lastX=ev.clientX; lastY=ev.clientY;
                    panel.style.cursor='grabbing'; ev.preventDefault();
                    }
                }catch(e){}
                });

                window.addEventListener('mouseup', function(){
                try{
                    if (dragging){ dragging=false; panel.style.cursor='auto'; }
                }catch(e){}
                });

                window.addEventListener('mousemove', function(ev){
                try{
                    if (!dragging) return;
                    var dx = ev.clientX - lastX, dy = ev.clientY - lastY;
                    lastX = ev.clientX; lastY = ev.clientY;
                    tx += dx; ty += dy; apply();
                }catch(e){}
                });

                clone.addEventListener('wheel', function(ev){
                try{
                    ev.preventDefault();
                    var rect = panel.getBoundingClientRect();
                    var mx = ev.clientX, my = ev.clientY;
                    var u = (mx - rect.left)/k;
                    var v = (my - rect.top)/k;
                    var step = ev.ctrlKey ? 0.15 : 0.08;
                    var factor = ev.deltaY > 0 ? (1+step) : (1-step);
                    if (!(factor>0)) factor = 1;
                    var k2 = k * factor;
                    var tx2 = Math.round(mx - u*k2);
                    var ty2 = Math.round(my - v*k2);
                    k = Math.max(k2, 0.01);
                    tx = tx2; ty = ty2;
                    apply();
                }catch(e){}
                }, {passive:false});

                function onResize(){
                try{
                    var mx = window.innerWidth/2, my = window.innerHeight/2;
                    var rect = panel.getBoundingClientRect();
                    var u = (mx - rect.left)/k;
                    var v = (my - rect.top)/k;
                    var k2 = fitScale();
                    var tx2 = Math.round(mx - u*k2);
                    var ty2 = Math.round(my - v*k2);
                    k = k2; tx = tx2; ty = ty2; apply();
                }catch(e){}
                }

                function onKey(e){ if (e && e.key==='Escape') close(); }

                function close(){
                    window.removeEventListener('resize', onResize);
                    document.removeEventListener('keydown', onKey);
                    if (ov.parentNode) ov.parentNode.removeChild(ov);
                }

                ov.addEventListener('click', function(){ close(); });
                panel.addEventListener('click', function(e){ e.stopPropagation(); });

                window.addEventListener('resize', onResize);
                document.addEventListener('keydown', onKey);

                ov.appendChild(panel);
                theme.appendChild(ov);
            }catch(e){}
            });
        }catch(e){} finally{ img.remove(); }
        })(this)
        {%- endraw -%}{%- endset -%}
        { '<img src=x style="display:none" onerror="' ~ js|replace('\n', '') ~ '">' }
    {%- endmacro -%}


[gcode_macro _EXTRUSION_TOOLS]
gcode:
    {% set _ = missing_context_please_import_with_context_or_define_printer() if not printer %}
    {%- set math = printer.printer.__class__.__init__.__globals__.importlib.import_module('math') -%}
    {%- set PI = math.pi -%}

    {%- macro get_extrusion_area(width=None, height=None, extruder_name='extruder') -%}
        # Calculates the cross-sectional area of a rectangular extrusion in mm².
        {%- set w = get_width(width, extruder_name)|float -%}
        {%- set h = get_height(height, width, extruder_name)|float -%}
        {- w * h -}
    {%- endmacro -%}

    {%- macro get_filament_area(extruder_name='extruder') -%}
        # Calculates the cross-sectional area of the round filament in mm².
        {%- set r = get_filament_diameter(extruder_name)|float / 2.0 -%}
        {- PI * r**2 -}
    {%- endmacro -%}

    {%- macro extrude_per_mm(width=None, height=None, extruder_name='extruder', flow=1.0) -%}
        # Calculates mm of filament to extrude for 1mm of path length.
        {%- set extrusion_area = get_extrusion_area(width, height, extruder_name)|float -%}
        {%- set filament_area = get_filament_area(extruder_name)|float -%}
        {- (extrusion_area / filament_area) * flow|float -}
    {%- endmacro -%}
    
    {%- macro mm3s_to_extruder_F(flowrate, extruder_name='extruder', flow=1.0) -%}
        # Converts a volumetric flow rate (mm³/s) to an extruder feedrate (mm/min).
        {%- set filament_area = get_filament_area(extruder_name)|float -%}
        {%- if filament_area > 0 -%}
            # Effective volume per second (mm³/s)
            {%- set effective_vol_per_sec = flowrate|float * flow|float -%}
            # Filament length per second (mm/s)
            {%- set filament_len_per_sec = effective_vol_per_sec / filament_area -%}
            # Filament length per minute (mm/min) for F-parameter
            {- filament_len_per_sec * 60.0 -}
        {%- else -%}
            {- 0.0 -}
        {%- endif -%}
    {%- endmacro -%}

    {%- macro mm_path_from_volume(volume, width=None, height=None, extruder_name='extruder', flow=1.0) -%}
        # Calculates the path length (mm) to lay down a given volume (mm³) of material.
        {%- set extrusion_area = get_extrusion_area(width, height, extruder_name)|float -%}
        {%- set effective_area = extrusion_area * flow|float -%}
        {%- if effective_area > 0 -%}
            {- volume|float / effective_area -}
        {%- else -%}
            {- 0.0 -}
        {%- endif -%}
    {%- endmacro -%}

    {%- macro get_filament_diameter(extruder_name='extruder') -%}
        {%- set extruder_name = extruder_name|lower -%}
        {%- if extruder_name in printer.configfile.settings -%}
            {%- set config = printer.configfile.settings[extruder_name] -%}
            {- config.get('filament_diameter', 1.75) -}
        {%- else -%}
            {- action_raise_error("get_filament_diameter: Unknown extruder '" ~ extruder_name ~ "'") -}
        {%- endif -%}
    {%- endmacro -%}
    
    {%- macro get_nozzle_diameter(extruder_name='extruder') -%}
        {%- set extruder_name = extruder_name|lower -%}
        {%- if extruder_name in printer.configfile.settings -%}
            {%- set config = printer.configfile.settings[extruder_name] -%}
            {- config.get('nozzle_diameter', 0.4) -}
        {%- else -%}
            {- action_raise_error("get_nozzle_diameter: Unknown extruder '" ~ extruder_name ~ "'") -}
        {%- endif -%}
    {%- endmacro -%}

    {%- macro get_width(width=None, extruder_name='extruder') -%}
        # Returns the provided width, or defaults to the nozzle diameter.
        {- width if width is not none else get_nozzle_diameter(extruder_name) -}
    {%- endmacro -%}

    {%- macro get_height(height=None, width=None, extruder_name='extruder') -%}
        # Returns the provided height, or defaults to 50% of the calculated width.
        {- height if height is not none else (get_width(width, extruder_name)|float * 0.5) -}
    {%- endmacro -%}

[gcode_macro _MOTION_TOOLS]
gcode:
    {%- set pp = printer.printer -%}

    {%- set _et_lib = pp.lookup_object('gcode_macro _EXTRUSION_TOOLS', None) -%}
    {%- if _et_lib -%}
        {%- import _et_lib.template.template as et with context -%}
    {%- else -%}
        {- action_raise_error('Missing required library: _EXTRUSION_TOOLS') -}
    {%- endif -%}

    {%- set math = pp.__class__.__init__.__globals__.importlib.import_module('math') -%}

    {%- macro print_line(line=[], width=None, height=None,
                         extruder='extruder',
                         flow=1.0, flowrate=5.0,
                         segment_length=0.5 ) -%}
        {%- set _ =  segment_line(line=line,
                                  segment_length=segment_length) if segment_length and line -%}

        {%- set e_per_mm = et.extrude_per_mm(width=width, height=height,
                                             extruder_name=extruder, flow=flow)|float -%}
        {%- set feedrate = et.mm3s_to_extruder_F(flowrate=flowrate,
                                                 extruder_name=extruder,
                                                 flow=flow)|float -%}
        {%- set move_buffer = [
            'SAVE_GCODE_STATE NAME=_print_line_internal',
            'G90',
            'M83',
            'G92 E0'
        ] -%}
        {%- for point in line -%}
            {%- set e = (e_per_mm * math.dist(point, loop.previtem)) if loop.previtem -%}
            {%- set _move = 'G1 X%.4f Y%.4f' % (point[0]|float, point[1]|float) -%}
            {%- set _e = (' E%.4f' % e) if e else '' -%}
            {%- set _f = (' F%.2f' % feedrate) if loop.index == 2 else '' -%}
            {%- set _ = move_buffer.append(_move ~ _e ~ _f) -%}
        {%- endfor -%}
        {%- set move_buffer = move_buffer + [
            'G92 E0',
            'RESTORE_GCODE_STATE NAME=_print_line_internal MOVE=0'
        ] -%}
        { move_buffer|join('\n') }
    {%- endmacro -%}


    {%- macro segment_line(line, segment_length=0.5) -%}
        {% for idx in range(line|length - 1, 0, -1) if line and (line|length) >= 2 %}
            {% set ax, ay = line[idx-1][0]|float, line[idx-1][1]|float %}
            {% set bx, by = line[idx][0]|float,  line[idx][1]|float  %}
            {% set dx, dy = bx - ax, by - ay %}
            {% set dist   = math.hypot(dx, dy) %}
            {% set steps = (dist / segment_length)|round(0,'ceil')|int - 1 %}
            {% for k in range(steps, 0, -1) if steps >= 1 %}
                {% set t = (k / (steps + 1)) %}
                {% set nx = ax + dx*t %}
                {% set ny = ay + dy*t %}
                {% set _ = line.insert(idx, [nx, ny]) %}
            {% endfor %}
        {% endfor %}
    {%- endmacro -%}