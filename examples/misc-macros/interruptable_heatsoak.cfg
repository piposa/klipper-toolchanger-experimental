[gcode_macro RESPOND]
variable_heatsoak_macro_name: 'PRINT_START'

[gcode_macro PRINT_START]
variable_soak_settings: {
        'enabled':                 True,    # <- change if dont want
        'min_temp_to_trigger':     65,      # Skip soak for prints with bed temp lower then this
        'min_duration_to_trigger': 30,      # Skip soak for prints shorter than this
        'soak_seconds_per_minute': 5,       # Seconds to soak for each minute of estimated print time.

        'skip_if_sensor_within' : 10,       # skips if chamber is already within XÂ°C of target from slicer
        'sensor_to_check':        ['chamber', 'CHAMBER_TEMP'], # [sensor_name, slicer_param]

        'soak_time': {      'min': 5,       # minutes defining upper and lower heat soaking time to clamp to
                            'max': 45,
        },
    }
variable_heatsoak_macro: "HEATSOAK"
variable_pause_command:  """
    PAUSE_BASE
    """
variable_resume_command: """
    M107
    RESTORE_GCODE_STATE NAME=PAUSE_STATE MOVE=0
    SAVE_GCODE_STATE NAME=PAUSE_STATE
    RESUME_BASE
    """
variable_state: {}
gcode: 
    {% set SELF      = 'PRINT_START' %}
    {% set SS        = soak_settings %}
    {% set th        = printer.toolhead %}
    {% set p_stats   = printer.print_stats %}

    {% set state = {} if 'BED' in params else state %} # hard reset. new print.

    {% macro main() %}

        {% if printer.pause_resume.is_paused %}
            {% set t_now    = p_stats.total_duration %}
            {% set elapsed  = t_now - state.get('last_total', t_now) %}
            {% set remain   = state.get('time_to_soak', 0.0) - elapsed %}
            {% set _ = state.update({
                'time_to_soak': remain,
                'last_total': t_now
            }) %}
        {% else %}
            {% set _ = state.clear() %}
            { err('Print cancelled externally, clearing/resetting') }
        {% endif %}

        {% if 'ADJUST' in params %}
            {% set new_duration = clamp_time(state.get('time_to_soak', 0.0) + params.ADJUST|float(0.0) * 60.0)|float %}
            {% set _ = state.update({
                'time_to_soak': new_duration,
                'reminded':     False,
                'last_total':   p_stats.total_duration
            }) %}
            { _show_UI(new_duration) }
            { _tick(new_duration) }
        {% elif 'CANCEL' in params %}
            {% set state = {} %}
            { ui('end') }
            UPDATE_DELAYED_GCODE ID=_HEAT_SOAK_UPDATE DURATION=0
            CANCEL_PRINT
        {% elif 'SKIP' in params %}
            { ui('end') }
            { _resume_and_print() }
        {% elif 'TICK_UPDATE' in params and 'params' in state %}
            { _tick(remain) }
        {% elif 'SHOW_UI' in params and 'params' in state %}
            { _show_UI(state.get('time_to_soak', -1)) }
        {% elif 'CLOSE' in params %}
            { msg('Soaking for ' ~ format_time(state.time_to_soak or 0.0) ~ 
                  ' to reopen the ui: <a class="command text--blue">' ~ SELF ~ ' SHOW_UI=1</a>') }
            { ui('end') if state.ui_is_open else '' }
            {% set _ = state.update({'ui_is_open': False}) %}
        {% endif %}
    {% endmacro %}

    {% macro msg(s, prefix_color="--v-accent-base, orange", msg_color="--p-text-color2, grey") %}
        {% set desc = printer.configfile.settings['gcode_macro ' ~ SELF|lower].description|trim|trim('"')|trim("'") %}
        {% set pre  = "<span style=\"color: var(" ~ prefix_color ~ "); font-weight:bold;\" title=\"" ~ desc ~ "\">" ~ SELF ~ " </span>" %}
        { action_respond_info(pre ~ "<span style=\"color: var(" ~ msg_color ~ ");\" title=\"" ~ desc ~ "\">" ~ s ~ "</span>") }
    {% endmacro %}
    {% macro err(s) %}{ msg(s, prefix_color="--v-error-base, red", msg_color="--v-warning-base, orange") }{% endmacro %}

    {%- macro decide_skip() -%}
        {%- set skip_conditions = [
            state.get('print_duration', -1) < SS.min_duration_to_trigger,
            SS.min_temp_to_trigger > state.params.get('BED_TEMP', -1)|int(-1),
            not SS.enabled
            ] -%}
            {% set _ = skip_conditions.append(
                (SS.skip_if_sensor_within|abs > get_sensor_target(SS.sensor_to_check[1])|float - get_sensor_temp(SS.sensor_to_check[0])|float)
            ) if SS.sensor_to_check and SS.sensor_to_check|length >= 2 
                 and get_sensor_target(SS.sensor_to_check[1]) 
                 and get_sensor_temp(SS.sensor_to_check[0]) 
            %}
        {- True if skip_conditions|select|list else '' -} # just is alteast 1 of them true
    {%- endmacro -%}

    {%- macro initialize() -%}
        {% if 'params' not in state %}
            {% set print_duration = get_duration_from_name(p_stats.filename)|int %}
            {% set time_to_soak   = clamp_time(SS.soak_seconds_per_minute * (print_duration / 60.0))|float %}
            {% set _ = state.update({
                'params':         params,
                'time_to_soak':   time_to_soak,
                'print_duration': print_duration,
                'last_total':     p_stats.total_duration
            }) %}
            { pause_command }
            UPDATE_DELAYED_GCODE ID=_HEAT_SOAK_UPDATE DURATION=0.1 
        {% elif decide_skip() %}
            { _resume_and_print() }
        {% else %}
            { _show_UI(state.get('time_to_soak', -1)) }
            {% if toolchanger_helper %}
                {% import toolchanger_helper as tch with context %}
                { tch.check_ok() }
            {% endif %}
            { heatsoak_macro ~ ' ' ~ state.params|xmlattr }
            { 'PART_AREA' if 'gcode_macro PART_AREA' in printer else '' }
            {% set _ = state.update({ 'initialized': True }) %}
        {% endif %}
    {%- endmacro -%}
    # â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
    {%- macro ui(msg)  -%}          { action_respond_info('action:prompt_' ~ msg) }                  {%- endmacro -%}
    {%- macro add(msg) -%}          { ui(msg) } { ui('show') }                                       {%- endmacro -%}
    {%- macro center_but_val(label) -%} 
        { (('ï¼‹' ~ label if label > 0 else 'âˆ’' ~ label|string|replace('-', '')) ~ 'â€¯ğ—†ğ—‚ğ—‡').center(7, 'â €') }
    {%- endmacro -%}

    {%- macro clamp_time(val) -%}        
        { [ [ SS.soak_time.min * 60.0, val|float(0) ]|max, SS.soak_time.max * 60.0 ]|min } 
    {%- endmacro -%}

    {%- macro format_time(sec) -%}
        {%- set parts, s = [], sec|int(0) -%}
        {%- set units = [
            ( s // 86400,          'd'),
            ((s %  86400) // 3600, 'h'),
            ((s %  3600)  // 60,   'm'),
            ( s %  60,             's'),
        ] -%}
        {%- for v, label in units if v -%}
            {%- set _ = parts.append(v ~ label) -%}
        {%- endfor -%}
        { parts[0:2]|join(' ') }
    {%- endmacro -%}

    {%- macro get_duration_from_name(fname) -%}
        {%- set glob     = printer.printer.__class__.__init__.__globals__ -%}
        {%- set re       = glob.importlib.import_module('re') -%}
        {%- set unit_map = {'d': 86400, 'h': 3600, 'm': 60, 's': 1} -%}
        {%- set matches = re.findall('([0-9]+)([dhms])', fname|string|lower) -%}
        {%- set durations = [] -%}
        {%- for num, unit in matches if unit in unit_map -%}
            {%- set _ = durations.append(num|float(0) * unit_map[unit]) -%}
        {%- endfor -%}
        {%- if not durations -%}
            { err('Failed to determine print duration, defaulting to 1h') }
            {%- set _ = durations.append(60*60) -%}
        {%- endif -%}
        { durations|sum }
    {%- endmacro -%}

    {%- macro polygon_area(poly) -%}
        {%- set segs, n = [], poly|length -%}
        {%- for x1, y1 in poly -%}
            {%- set j      = (loop.index0 + 1) % n -%}
            {%- set x2, y2 = poly[j][0], poly[j][1] -%}
            {%- set _      = segs.append(x1 * y2 - x2 * y1) -%}
        {%- endfor -%}
        { (segs|sum / 2.0)|abs }
    {%- endmacro -%}

    {%- macro max_polygon_area(objs) -%}
        {%- set areas = [] -%}
        {%- for p in objs|map(attribute='polygon') -%}
            {%- set _ = areas.append(polygon_area(p)) -%}
        {%- endfor -%}
        { areas|map('float')|list|max }
    {%- endmacro -%}

    {%- macro get_sensor_target(paramter='') -%}
        {%- if paramter -%}
            {%- set chamber_target = params.get(paramter, state.get('params', {}).get(paramter, None)) -%}
            {- chamber_target if chamber_target is not none else '' -}
        {%- endif -%}
    {%- endmacro -%}

    {%- macro get_sensor_temp(sensor='') -%}
        {%- if sensor|trim -%}
            {%- set temp = [] -%}
            {%- for heater in printer.heaters.available_sensors if (heater|lower).endswith(sensor|trim|lower) and not temp -%}
                {%- set _ = temp.append(printer[heater].temperature) -%}
            {%- endfor -%}
            {- temp|first or '' -}
        {%- endif -%}
    {%- endmacro -%}
    # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

    # â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Reset and start print â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
    {%- macro _resume_and_print() -%}
        UPDATE_DELAYED_GCODE ID=_HEAT_SOAK_UPDATE DURATION=0
        M107
        { resume_command }
        _PRINT_START {state.params|xmlattr}
        {% set _ = state.clear() %}
    {%- endmacro -%}
    # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

    # â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Open Popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
    {%- macro _show_UI(soak_for) -%}    
        { ui('begin heat soaking for ' ~ p_stats.filename.split('_')[0]|default('next print')) }
        { ui('text upcoming print duration: ' ~ format_time(state.get('print_duration', -1)))}
        { ui('text heat soaking for: ' ~ format_time(soak_for))}
        { ui('text largest part area in this print: ' ~ (max_polygon_area(printer.exclude_object.objects)|float / 100.0)|int ~ 'cmÂ²')}
        { ui('button_group_start') }
        {% for step in [15, 10, 5, -15, -10, -5] %}
            { ui('button ' ~ center_but_val(step) ~ '|' ~ SELF ~ ' ADJUST=' ~ step ~ '|accent--text text--' ~ ('lighten' if step > 0 else 'darken') ~ '-3') }
        {% endfor %}
        { ui('button_group_end') }
        { ui('footer_button [ ğŸ—™ ] Close|'  ~ SELF ~ ' CLOSE=1|error') }
        { ui('footer_button [ â¹ ] Cancel|' ~ SELF ~ ' CANCEL=1|error') }
        { add('footer_button [ â–¶ ] Skip|'   ~ SELF ~ ' SKIP=1|success') }
        {'POPUP_DIALOG_CTRL TARGET="heat soaking for" EXACT=0' if 'gcode_macro POPUP_DIALOG_CTRL' in printer else ''}
        {% set _ = state.update({'ui_is_open': True}) %}
    {%- endmacro -%}
    # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

    # â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Update Popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
    {% macro _tick(seconds_left) %}
        {% set s = seconds_left|int %}
        {% if s <= 0 %}
            { ui('end') }
            { _resume_and_print() }
        {% else %}
            {% if s > 300 %}      # more than 5 min -> update every 5 min
                {% set interval = 300 %}
            {% elif s > 60 %}     # 1â€“5 min -> update every 1 min
                {% set interval = 60 %}
            {% elif s > 10 %}     # 10â€“60 s -> update every 10 s
                {% if state and not state.reminded %} 
                    { _show_UI(seconds_left) } 
                    {% set _ = state.update( {'reminded': True} ) %}
                {% endif %}
                {% set interval = 10  %}
            {% else %}
                {% set interval = 5   %}
            {% endif %}
            UPDATE_DELAYED_GCODE ID=_HEAT_SOAK_UPDATE DURATION={interval/2}
            {% if state.ui_is_open %}
                { add('text ' ~ format_time(s) ~ ' remainingâ€¦') }
            {% else %}
                { msg(format_time(s) ~ ' remainingâ€¦') }
            {% endif %}
        {% endif %}
    {% endmacro %}
    # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

    {% if state.initialized %}
        { main() }
    {% else %}
        { initialize() }
    {% endif %}
    SET_GCODE_VARIABLE MACRO={SELF} VARIABLE=state VALUE="{state}"


[delayed_gcode _HEAT_SOAK_UPDATE]
gcode:
    UPDATE_DELAYED_GCODE ID=_HEAT_SOAK_UPDATE DURATION=0
    {% if printer['gcode_macro PRINT_START'].state %}
        PRINT_START TICK_UPDATE=1
    {% endif %}


[gcode_macro RESPOND]
rename_existing: _RESPOND_HEATSOAK_INFERRED
gcode:
    _RESPOND_HEATSOAK_INFERRED {rawparams}
    # just make sure its not part of a UI element, and actually a close
    {% if 'action:prompt_end' in rawparams and not 'RESPOND' in rawparams %}
        {% set state = printer['gcode_macro ' ~ heatsoak_macro_name].state %}
        {% if state.get('ui_is_open', False) %}
            {% set _ = state.update({'ui_is_open': False}) %}
            SET_GCODE_VARIABLE MACRO=DOCK_TUNER VARIABLE=state VALUE="{state}"
            { heatsoak_macro_name } CLOSE=1
        {% endif %}
    {% endif %}

[gcode_macro PART_AREA]
variable_colors:{
        'lines':        'cyan',
        'fill':         'gray',
        'background':   'black',
        'bed_frame':    'white',
    }
gcode:
    # â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Determine area per polygon â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
    {%- macro polygon_area(poly) -%}
        {%- set segs, n = [], poly|length -%}
        {%- for x1, y1 in poly -%}
            {%- set j      = (loop.index0 + 1) % n -%}
            {%- set x2, y2 = poly[j][0], poly[j][1] -%}
            {%- set _      = segs.append(x1 * y2 - x2 * y1) -%}
        {%- endfor -%}
        { (segs|sum / 2.0)|abs }
    {%- endmacro -%}
    # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

    # â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ determine the maximum poly area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
    {%- macro max_polygon_area(objs) -%}
        {%- set areas = [] -%}
        {%- for p in objs|map(attribute='polygon') -%}
            {%- set _ = areas.append(polygon_area(p)) -%}
        {%- endfor -%}
        { areas|map('float')|list|max }
    {%- endmacro -%}
    # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

    # â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ build the SVG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
    {%- macro draw_buildplate_layout_svg(objs, w, h, pad=10) -%}
        {%- set total_w, total_h = (w + pad * 2), (h + pad * 2) -%}
        {%- set svg_parts        = [] -%}
        {%- set _ = svg_parts.append('<svg xmlns="http://www.w3.org/2000/svg" width="' ~ total_w|round(0) ~ '" height="' ~ total_h|round(0) ~ '" viewBox="0 0 ' ~ total_w|round(0) ~ ' ' ~ total_h|round(0) ~ '" style="background-color:' ~ colors.background ~ ';">') -%}
        {%- set _ = svg_parts.append('<rect x="' ~ pad ~ '" y="' ~ pad ~ '" width="' ~ w ~ '" height="' ~ h ~ '" fill="none" stroke="' ~ colors.bed_frame ~ '" stroke-width="1" />') -%}
        
        {%- for obj in objs -%}
            {%- set pts = [] -%}
            {%- for x, y in obj.polygon -%}
                {%- set _ = pts.append((x + pad)|round(2) ~ ',' ~ (h - y + pad)|round(2)) -%}
            {%- endfor -%}
            {%- set _ = svg_parts.append(
                '<polygon points="' ~ pts|join(' ') ~ '" stroke="' ~ colors.lines ~ 
                '" fill="' ~ colors.fill ~ '" stroke-width="1" />'
            ) -%}
        {%- endfor -%}
        { svg_parts|join('') ~ '</svg>' }
    {%- endmacro -%}
    # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

    {% set objects = printer.exclude_object.objects %}
    {% if objects %}
        {% set bed_x = printer.toolhead.axis_maximum.x|float %}
        {% set bed_y = printer.toolhead.axis_maximum.y|float %}
        { action_respond_info(draw_buildplate_layout_svg(objects, bed_x, bed_y)) }
        { action_respond_info('largest thingy: ' ~ (max_polygon_area(printer.exclude_object.objects)|float / 100)|round(2) ~ 'cmÂ²') }
    {% endif %}