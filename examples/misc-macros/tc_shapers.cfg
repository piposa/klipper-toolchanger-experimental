
[Input_shaper]

[gcode_macro TC_SHAPER_CALIBRATE]
description: Runs a shaper thingy [T=<0,1,2...> or <all>], default → current tool
variable_save_to_svf: True
variable_save_to_config: False
variable_show_images: True


[gcode_macro SHOW_LATEST_SHAPER_PLOT]
description: Find latest shaper CSV (X/Y), render plot(s), and post clickable previews
variable_settings: {
        'async':             1,
        'prefix':            'shaper_plot_',
        'suffix':            '%Y-%m-%d_%H-%M',
        'axis':              'XY',
        'max_px':            400,
        'open_size_percent': 75,
        'python_path':       '',
        'script_path':       '~/klipper/scripts/calibrate_shaper.py',
        'save_path':         '~/printer_data/config/toolchanger/ShaperManagement/shaper_img'
    }
variable_verbose: True

[gcode_macro _TC_SHAPER_CALIBRATE_SAVE_TO_SVF]
description: "Save pending input_shaper values into SVF for tools"
variable_defaults: {
        'type': "MZV",
        'freq': 0.0,
        'damp': 0.2
    } 
    
[gcode_macro SHAPER_CALIBRATE]
rename_existing: _SHAPER_CALIBRATE
gcode:
    {% set act_tool_name = printer.toolchanger.tool_names[printer.toolchanger.tool_number] %}
    {% set accel = (printer[act_tool_name].get('params_accelerometer', 'adxl345 ' ~ name|replace('tool ', '')))|string %}
    {% if 'CHIPS' not in params and accel|lower in printer.configfile.settings %}
        {% set _ = params.update({'CHIPS': accel }) %}
    {% endif %}
    _SHAPER_CALIBRATE {params|xmlattr}

[gcode_macro TC_LOAD_SHAPERS]
description: "Load input_shaper from SVF (preferred) or tool params"
gcode:
    {% set SELF = 'TC_LOAD_SHAPERS' %}
    {% macro msg(s, prefix_color="--v-accent-base", msg_color="--p-text-color2", extra='') %}
        {% set extra = ('\u0026\u0023\u0031\u0030\u003b' ~ extra) if extra else extra %}
        {% set desc = printer.configfile.settings['gcode_macro ' ~ SELF|lower].description %}
        {% set pre  = "<span style=\"color: var(" ~ prefix_color ~ "); font-weight:bold;\" title=\"" ~ desc ~ "\">" ~ SELF ~ " </span>" %}
        { action_respond_info(pre ~ "<span style=\"color: var(" ~ msg_color ~ ");\" title=\"" ~ desc ~ extra ~ "\">" ~ s ~ "</span>") }
    {% endmacro %}
    {% macro err(s) %}{ msg(s, prefix_color="--v-error-base", msg_color="--v-warning-base") }{% endmacro %}

    {% set toolchanger = printer.toolchanger %}

    {% set tn = params.T|default(toolchanger.tool_number)|int %}
    {% if tn not in toolchanger.tool_numbers %}
        { err('Invalid tool number: ' ~ tn) }
    {% else %}
        {% set name       = toolchanger.tool_names[tn] %}
        {% set tool       = printer[name] %}
        {% set svf_s_key  = 'shapers_' ~ name|replace('tool ', '')|lower %}
        {% set svf        = printer.save_variables.variables or {} %}
        {% set svfs       = svf.get(svf_s_key, {}) %}
        {% set specs = [
            ('type',           'SHAPER_TYPE_',         'params_input_shaper_type_'),
            ('freq',           'SHAPER_FREQ_',         'params_input_shaper_freq_'),
            ('damp',           'DAMPING_RATIO_',       'params_input_shaper_damping_ratio_') 
        ] %}
        {% set cmd = [] %}
        {% for ax in ['x','y'] %}
            {% set s      = svfs.get(ax, {}) %}
            
            {% set type   = s.get('type', tool.get('params_input_shaper_type_' ~ ax, ''))|string|upper %}
            {% set fval   = s.get('freq', tool.get('params_input_shaper_freq_' ~ ax, None)) %}
            {% set dval   = s.get('damp', tool.get('params_input_shaper_damping_ratio_' ~ ax, None)) %}

            {% set freq_key = ('SMOOTHER' if 'SMOOTH' in type else 'SHAPER') ~ '_FREQ_' ~ ax|upper %}

            {% set _ = cmd.append('SHAPER_TYPE_' ~ ax|upper ~ '=' ~ type) if type %}
            {% set _ = cmd.append(freq_key ~ '=' ~ fval) if fval %}
            {% set _ = cmd.append('DAMPING_RATIO_' ~ ax|upper ~ '=' ~ dval) if (not 'SMOOTH' in type) and dval %}
        {% endfor %}

        {% if cmd|length == 0 %}
            { err('No input_shaper data found for ' ~ name|replace('tool ', '')) }
        {% else %}
            {'SET_INPUT_SHAPER ' ~ ' '.join(cmd)}
            { msg('Loaded ' ~ name|replace('tool ', '') ~ '\'s shapers', ' '.join(cmd)) }
        {% endif %}
    {% endif %}
    
[gcode_macro TC_SHAPER_CALIBRATE]
gcode:
    {% set SELF = 'TC_SHAPER_CALIBRATE' %}
    {% macro msg(s, prefix_color="--v-accent-base", msg_color="--p-text-color2") %}
        {% set desc = printer.configfile.settings['gcode_macro ' ~ SELF|lower].description %}
        {% set pre  = "<span style=\"color: var(" ~ prefix_color ~ "); font-weight:bold;\" title=\"" ~ desc ~ "\">" ~ SELF ~ " </span>" %}
        { action_respond_info(pre ~ "<span style=\"color: var(" ~ msg_color ~ ");\" title=\"" ~ desc ~ "\">" ~ s ~ "</span>") }
    {% endmacro %}
    {% macro err(s) %}{ msg(s, prefix_color="--v-error-base", msg_color="--v-warning-base") }{% endmacro %}

    {% set P            = printer %}
    {% set cfg          = P.configfile.settings %}
    {% set tc           = P.toolchanger %}
    {% set tns          = tc.tool_numbers %}
    {% set cur          = tc.tool_number %}
    {% set req          = params.T|default(cur)|string %}
    {% set queue, tinfo = [], [] %}

    {% for raw in (tns if req == 'all' else req.split(',')|map('trim')) %}
        {% set tn = raw|int(-1) %}
        {% if tn in tns and tn not in queue %} 
            {% set _ = queue.insert(0, tn) if tn == cur else queue.append(tn) %}
        {% elif raw|trim and tn not in tns %} 
            { msg("Tool '" ~ raw ~ "' invalid, skipping.") }
        {% endif %}
    {% endfor %}
    {% if queue|length == 0 %}
        { err("No valid tools to process.") }
    {% elif tc.status != 'ready' %}
        { err("Cannot run, toolchangers status '" ~ tc.status ~ "' is not ready.") }
    {% elif cfg.toolchanger.on_axis_not_homed != 'home' and P.toolhead.homed_axes != 'xyz' %}
        { err('Please home all axis first.') }
    {% else %}

        {% if P.toolhead.homed_axes != 'xyz' %}
            { msg('Homing first') }
            G28
        {% endif %}

        {% for tn in queue %}
            {% set name   = tc.tool_names[tn] %}
            {% set accel  = (P[name].get('params_accelerometer', 'adxl345 ' ~ name|replace('tool ', '')))|string %}
            {% set _ = tinfo.append([tn, accel, name]) %}
        {% endfor %}

        {% for tn, accel, name in tinfo %}
            {% if accel|lower in cfg %} 
                { msg('Running calibration for ' ~ name|replace('tool ', '') ~ ' (accel: ' ~ accel ~ ')') }
                { ('T' ~ tn) if cur != tn else ''} 
                SHAPER_CALIBRATE CHIPS="{accel}"
                { ("SHOW_LATEST_SHAPER_PLOT PREFIX=plot_" ~ (name|replace('tool ', '')|lower)) if 'gcode_macro show_latest_shaper_plot' in cfg and show_images else '' }
                {% if save_to_svf %}    _TC_SHAPER_CALIBRATE_SAVE_TO_SVF NAME="{name|replace('tool ', '')}" {% endif %}
                {% if save_to_config %} _TC_SHAPER_CALIBRATE_SAVE_PARAMS NAME="{name|replace('tool ', '')}" {% endif %}
            {% else %} 
                { err("did not find a [" ~ accel ~ "] section.<br>(remember to either define your name in the tools 'params_accelerometer' or name them the same as your tools!)") }
            {% endif %}
        {% endfor %}

    {% endif %}


[gcode_macro _TC_SHAPER_CALIBRATE_SAVE_TO_SVF]
gcode:
    {% set SELF = '_TC_SHAPER_CALIBRATE_SAVE_TO_SVF' %}
    {% macro msg(s, prefix_color="--v-accent-base", msg_color="--p-text-color2") %}
        {% set desc = printer.configfile.settings['gcode_macro ' ~ SELF|lower].description %}
        {% set pre  = "<span style=\"color: var(" ~ prefix_color ~ "); font-weight:bold;\" title=\"" ~ desc ~ "\">" ~ SELF ~ " </span>" %}
        { action_respond_info(pre ~ "<span style=\"color: var(" ~ msg_color ~ ");\" title=\"" ~ desc ~ "\">" ~ s ~ "</span>") }
    {% endmacro %}
    {% macro err(s) %}{ msg(s, prefix_color="--v-error-base", msg_color="--v-warning-base") }{% endmacro %}

    {% set pend = printer.configfile.save_config_pending_items.input_shaper or {} %}
    {% if pend == {} %}
        { err("No pending input_shaper data found.") }
    {% elif params.get('NAME','') == '' %}
        { err("Missing paramater [NAME]") }
    {% else %}
        # load existing
        {% set svf_key = 'shapers_' ~ params.NAME|lower %}
        {% set svf     = printer.save_variables.variables or {} %}
        {% set merged  = svf.get(svf_key, {'x': {}, 'y': {}}) %}

        {% for ax in ['x', 'y'] %}
            {% set cur   = merged.get(ax, {}) %}
            {% set tkey  = 'shaper_type_' ~ ax %}
            {% set tval  = (pend.get(tkey, cur.get('type', defaults['type']))|string).upper() %}
            {% set is_sm = 'SMOOTH' in tval %}

            {% set fkey  = ('smoother_freq_' if is_sm else 'shaper_freq_') ~ ax %}
            {% set fval  = pend.get(fkey, cur.get('freq', defaults['freq'])) %}

            {% set dkey  = 'damping_ratio_' ~ ax %}
            {% set dval  = (pend.get(dkey, cur.get('damp', defaults['damp'])) if not is_sm) %}

            {% set _ = cur.update({'type': tval, 'freq': fval|float}) %}
            {% set _ = cur.update({'damp': dval|float}) if not is_sm and dval %}

            {% set _ = merged.update({ax: cur}) %}
        {% endfor %}

        SAVE_VARIABLE VARIABLE={svf_key} VALUE="{merged}"
        { msg("Shaper values saved as '" ~ svf_key ~ "' in your svf") }
    {% endif %}

[gcode_macro SHOW_LATEST_SHAPER_PLOT]
gcode:
    # ------- parameter parsing into settings overwrite
    {% set settings = settings.copy() %}
    {% for p in params if p|lower in settings %}
        {% set _ = settings.update({p|lower: params[p]|int(params[p])}) %}
    {% endfor %}

    {% set gbl     = printer.printer.__class__.__init__.__globals__ %}
    {% set imp_mod = gbl.importlib.import_module %}
    {% set sp      = imp_mod('subprocess') %}
    {% set bi      = imp_mod('builtins') %}
    {% set os      = imp_mod('os') %}
    {% set glob    = imp_mod('glob') %}
    {% set time    = imp_mod('time') %}
    {% set b64     = imp_mod('base64') %}
    {% set sys     = imp_mod('sys') %}

    # ------- Main macro that runs
    {%- macro main() -%}
        {% set parts = [
            'Latest shaper plots (' ~ settings.axis ~ ')',
            '<div style="display:grid;grid-template-columns:1fr;gap:12px">'
        ] %}
        {%- for _ax in settings.axis|upper|list -%}
            {% set _ = parts.append('<div>' ~ axis_block(ax=_ax, **settings) ~ '</div>') %}
        {%- endfor -%}
        {%- set _ = parts.append('</div>') -%}
        { action_respond_info(parts|join|replace('\n','')) }
    {%- endmacro -%}

    # ------- find the newest CSV that contains data in temp folder
    {%- macro newest_csv_for_axis(ax=None) -%}
        {%- set pats = {
            'X': ['/tmp/resonances_x_*.csv','/tmp/shaper*_x_*.csv','/tmp/calibration_data_x_*.csv'],
            'Y': ['/tmp/resonances_y_*.csv','/tmp/shaper*_y_*.csv','/tmp/calibration_data_y_*.csv']
        } -%}
        {%- set files = [] -%}
        {%- for pat in pats[ax] if ax -%}
            {%- for f in glob.glob(pat) -%}
                {%- set _ = files.append(f) -%}
            {%- endfor -%}
        {%- endfor -%}
        {%- set latest = bi.max(files, key=os.path.getmtime) if files|length > 0 else '' -%}
        {- dbg('csv[' ~ ax ~ ']: ' ~ (latest if latest else 'none') ~ ' (count=' ~ files|length ~ ')') -}
        {- latest -}
    {%- endmacro -%}

    # ------- actual call to python, returns file path to png
    {%- macro render_path(save_path='', python_path='', script_path='', async=0, prefix='', ax=None, suffix='') -%}
        {%- set _, _ = vaargs, kwargs -%}
        {%- set csv = newest_csv_for_axis(ax) -%}
        {%- if not csv -%}
            {- dbg('render[' ~ ax ~ ']: no CSV → skip') -}
        {%- else -%}
            {%- set expand  = os.path.expanduser -%}
            {%- set py      = expand(python_path) -%}
            {%- set script  = expand(script_path) -%}
            {%- if not py or not os.path.exists(py) -%}
                {%- set py = sys.executable if os.path.exists(sys.executable) else '/usr/bin/python3' -%}
            {%- endif -%}
            {%- set sdir = expand(save_path) if save_path else '/tmp' -%}
            {%- set mk   = (os.makedirs(sdir, 511, True) if not os.path.exists(sdir) else None) -%}
            {%- set pfx  = (prefix ~ '_') if prefix and not prefix|list|last in [' ', '-', '_'] else prefix -%}
            {%- set sfx  = ('_' ~ suffix) if suffix and not suffix|list|first in [' ', '-', '_'] else suffix -%}
            {%- set base = (time.strftime(pfx ~ ax ~ sfx) ~ '.png')|lower -%}
            {%- set out  = os.path.join(sdir, base) -%}
            {- dbg('cmd[' ~ ax ~ ']: ' ~ py ~ ' ' ~ script ~ ' ' ~ csv ~ ' -o ' ~ out) -}
            {%- set cmd  = [py, script, csv, '-o', out] -%}
            {%- if async -%}
                {%- set _ = sp.Popen(cmd, stdout=sp.DEVNULL, stderr=sp.DEVNULL) -%}
                {- dbg('spawn[' ~ ax ~ ']: ' ~ out) -}
                {- out -}
            {%- else -%}
                {%- set res    = sp.run(cmd, stdout=sp.PIPE, stderr=sp.STDOUT) -%}
                {%- set outtxt = ((res.stdout or bi.bytes()) + (res.stderr or bi.bytes())).decode('utf-8', 'ignore') -%}
                {- dbg('sync[' ~ ax ~ ']: rc=' ~ res.returncode ~ ' exists=' ~ os.path.exists(out)) -}
                {- dbg(outtxt if outtxt else '(no output)') -}
                {- out if res.returncode|int == 0 and os.path.exists(out) else '' -}
            {%- endif -%}
        {%- endif -%}
    {%- endmacro -%}

    # ------- converts the png to B64 or link so that HTML img knows where to look for it
    {%- macro show_plot(path='', async=0, img_serve='/server/files/') -%}
        {%- if not path -%}
            {- 'No plot rendered.' -}
        {%- else -%}
            {%- if async -%}
                {%- set rp  = os.path.realpath(path) -%}
                {%- set rel = rp.split('/printer_data/', 1)[1] if '/printer_data/' in rp -%}
                {%- set img = (os.path.join(img_serve, rel) ~ '?t=' ~ (time.time() * 1000)|int) if rel -%}
                {- dbg('preview(async): rel=' ~ (rel or 'n/a') ~ ' url=' ~ (img or 'n/a')) -}
            {%- else -%}
                {%- set data = bi.open(path, 'rb').read() -%}
                {%- set enc  = b64.b64encode(data) -%}
                {%- set img  = 'data:image/png;base64,' ~ enc.decode('ascii') -%}
                {- dbg('preview(sync): ' ~ path ~ ' bytes=' ~ data|length) -}
            {%- endif -%}
            {%- if img -%}
                {- img_click_open(src=img, async=async, **kwargs) -}
            {%- else -%}
                {- 'Preview not available.' -}
            {%- endif -%}
        {%- endif -%}
    {%- endmacro -%}

    # ------- axis wrapper, kicks off render etc
    {%- macro axis_block(ax, async=0) -%}
        {- dbg('axis_block[' ~ ax ~ ']: async=' ~ async) -}
        {%- set path = render_path(ax=ax, async=async, **kwargs) -%}
        {- dbg('path[' ~ ax ~ ']: ' ~ (path if path else '')) -}
        {%- if not path -%}
            { 'No ' ~ ax ~ '-axis CSV found in /tmp or render failed.' }
        {%- else -%}
            {%- set html = show_plot(path=path, async=async, img_title=(ax ~ '-axis shaper plot'), **kwargs) -%}
            {%- if async -%}
                {- html ~ 'Rendering in background → ' ~ path -}
            {%- else -%}
                {- html ~ ('Saved: ' ~ path) if kwargs.get('save_path') else '' -}
            {%- endif -%}
        {%- endif -%}
    {%- endmacro -%}

    # ------- image wrapper so its openable in full size
    {%- macro img_click_open(src, async=0, max_px=400, img_title='Click to open full-size', open_size_percent=75) -%}
        {%- set _, _ = vaargs, kwargs -%}
        {%- set zoom_factor = [[open_size_percent|int, 100]|min, 10]|max / 100.0 -%}
        {%- set sanitized_src_id = 'plot-container-' ~ src.split('?')[0]|replace('/','-')|replace('.','-')|replace(':','-') -%}
        {%- set out =
            '<div id="' ~ sanitized_src_id ~ '" data-zoom="' ~ zoom_factor ~ '" style="max-inline-size:' ~ max_px ~ 'px;inline-size:100%;cursor:zoom-in;">' ~
            '<div class="img_box" style="inline-size:100%;background:var(--p-background-darker);border-radius:4px;">' ~
                (
                '<img data-main src="' ~ src ~ '" alt="' ~ img_title ~ '" draggable="false" ' ~
                'style="display:block;inline-size:100%;block-size:auto;object-fit:contain;" ' ~
                'onload="(function(i){i.style.aspectRatio=i.naturalWidth+\' / \'+i.naturalHeight;})(this)">' 
                if not async else
                '<div class="plot-placeholder" style="display:flex;align-items:center;justify-content:center;min-height:80px;padding:12px;font-size:90%;color:var(--v-text-darken1);">Generating Plot...</div>' ~
                '<img data-main alt="' ~ img_title ~ '" draggable="false" style="display:none;inline-size:100%;block-size:auto;object-fit:contain;">'
                ) ~
            '</div>' ~
            '</div>' ~
            '<img src="x" style="display:none" data-container-id="' ~ sanitized_src_id ~ '" data-url="' ~ src.split('?')[0] ~ 
            '" onerror="(function(el){try{var box=document.getElementById(el.dataset.containerId);if(!box||box.dataset.init){el.remove();return;}box.dataset.init=\'1\';var url=el.dataset.url;var ph=box.querySelector(\'.plot-placeholder\');var img=box.querySelector(\'img[data-main]\');var tries=0,max=90;function fitScale(nw,nh,z){var w=window.innerWidth,h=window.innerHeight;var k=Math.min((w*z)/nw,(h*z)/nh);return k>0?k:1}function openOverlay(pic){var nw=pic.naturalWidth,nh=pic.naturalHeight;var ov=document.createElement(\'div\');ov.setAttribute(\'style\',\'position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99999;cursor:zoom-out;overflow:hidden\');var panel=document.createElement(\'div\');panel.setAttribute(\'style\',\'position:absolute;left:0;top:0;transform-origin:0 0;cursor:auto\');var big=document.createElement(\'img\');big.draggable=false;big.src=pic.currentSrc||pic.src;big.setAttribute(\'style\',\'display:block;max-width:none;max-height:none;user-select:none;-webkit-user-drag:none\');panel.appendChild(big);ov.appendChild(panel);document.body.appendChild(ov);var z=parseFloat(box.dataset.zoom)||0.75;var k=fitScale(nw,nh,z),kmin=0.02,kmax=50,tx=Math.floor((window.innerWidth-nw*k)/2),ty=Math.floor((window.innerHeight-nh*k)/2);function apply(){panel.style.transform=\'translate(\'+tx+\'px,\'+ty+\'px) scale(\'+k+\')\';panel.style.width=nw+\'px\';panel.style.height=nh+\'px\';}apply();var drag=false,lx=0,ly=0;panel.addEventListener(\'mousedown\',function(e){if(e.button===0){drag=true;lx=e.clientX;ly=e.clientY;panel.style.cursor=\'grabbing\';e.preventDefault();}});window.addEventListener(\'mouseup\',function(){if(drag){drag=false;panel.style.cursor=\'auto\';}});window.addEventListener(\'mousemove\',function(e){if(!drag)return;var dx=e.clientX-lx,dy=e.clientY-ly;lx=e.clientX;ly=e.clientY;tx+=dx;ty+=dy;apply();});panel.addEventListener(\'wheel\',function(e){e.preventDefault();var r=panel.getBoundingClientRect();var mx=e.clientX,my=e.clientY;var u=(mx-r.left)/k,v=(my-r.top)/k;var step=e.ctrlKey?0.15:0.08;var f=e.deltaY<0?(1+step):(1-step);if(!(f>0))f=1;var k2=Math.min(Math.max(k*f,kmin),kmax);var tx2=Math.round(mx-u*k2),ty2=Math.round(my-v*k2);k=k2;tx=tx2;ty=ty2;apply();},{passive:false});function onRes(){var mx=window.innerWidth/2,my=window.innerHeight/2;var r=panel.getBoundingClientRect();var u=(mx-r.left)/k,v=(my-r.top)/k;var k2=fitScale(nw,nh,z);var tx2=Math.round(mx-u*k2),ty2=Math.round(my-v*k2);k=k2;tx=tx2;ty=ty2;apply();}function onKey(e){if(e&&e.key===\'Escape\')close();}function close(){window.removeEventListener(\'resize\',onRes);document.removeEventListener(\'keydown\',onKey);if(ov.parentNode)ov.parentNode.removeChild(ov);}ov.addEventListener(\'click\',function(){close();});panel.addEventListener(\'click\',function(e){e.stopPropagation();});window.addEventListener(\'resize\',onRes);document.addEventListener(\'keydown\',onKey);}function bindClick(){if(box.dataset.zoomReady)return;box.dataset.zoomReady=\'1\';box.addEventListener(\'click\',function(){var pic=box.querySelector(\'img[data-main]\');if(pic&&pic.complete&&pic.naturalWidth)openOverlay(pic);});}function poll(){tries++;var bust=Date.now();var probe=new Image();probe.onload=function(){img.src=url+\'?t=\'+bust;img.style.display=\'block\';if(ph)ph.style.display=\'none\';img.onload=function(){img.style.aspectRatio=img.naturalWidth+\' / \'+img.naturalHeight;};bindClick();};probe.onerror=function(){if(tries<max){setTimeout(poll,400+Math.min(tries*120,2000));}else{if(ph)ph.textContent=\'Failed to load plot.\';}};probe.src=url+\'?t=\'+bust;}poll();}catch(e){}finally{el.remove();}})(this)">' -%}
        {- out|replace('\n','') -}
    {%- endmacro -%}

    # ------- dbug/log output
    {% set _dbg = [] %}
    {%- macro dbg(msg) -%}{%- set _ = _dbg.append('<p>' ~ msg|replace('\n', '<br>') ~ '</p>') if verbose -%}{%- endmacro -%}
    
    { main() }

    {%- set block -%}
        <details>
            <summary style="cursor:pointer; color:var(--v-accent-base); margin:6px 0 3px 0;"><span class="text--primary">Log</span></summary>
            <blockquote class="accent--text text--lighten-1"
                        style="display:inline-block; width:fit-content; max-width:90%;
                                margin-top:0.6em; white-space:pre-wrap;
                                overflow-wrap:anywhere; word-break:break-word;
                                padding:0.5em 0.75em; border-left:3px solid currentColor;
                                background:var(--p-background-darker, rgba(255,255,255,0.06)); line-height:1.25em; font-size:75%;">
                <span class="text--primary">{_dbg|join()}</span>
            </blockquote>
        </details>
    {%- endset -%}
    { action_respond_info(block|replace('\n', '')) if _dbg else '' }


    
[gcode_macro _TC_SHAPER_CALIBRATE_SAVE_PARAMS]
description: "Save pending input_shaper values into the active / selected tool's parameters and clear the pending block."
variable_default_type: "MZV"
variable_default_freq: 0
variable_default_damp: 0.1
gcode:
  {% set cf   = printer.configfile %}
  {% set pend = cf.save_config_pending_items.get('input_shaper', {}) %}
  {% set P   = printer %}
  {% set tool = P[P.toolchanger.tool_names[P.toolchanger.tool_number]] %}
  {% if pend == {} %}
    RESPOND TYPE=error MSG="No pending input_shaper data found."
  {% else %}
    # --------< helper
    {% macro set_and_save(param, value) -%}
      SET_TOOL_PARAMETER  {rawparams} PARAMETER={param} VALUE={value}
      SAVE_TOOL_PARAMETER {rawparams} PARAMETER={param}
    {%- endmacro %}

    # --------< grab all from staged save
    {% for ax in ['x', 'y'] %}
      {% set type_val = (pend.get('shaper_type_' ~ ax,  default_type))|string|upper %}
      {% set freq_val = (pend.get('shaper_freq_' ~ ax,  default_freq))|string %}
      {% set damp_val = (tool.get('params_input_shaper_damping_ratio_' ~ ax, default_damp))|string %} # get from tool or default... (not in pending...)
      # --------< use small helper to save.
      {set_and_save('params_input_shaper_type_' ~           ax, type_val)}
      {set_and_save('params_input_shaper_freq_' ~           ax, freq_val)}
      {set_and_save('params_input_shaper_damping_ratio_' ~  ax, damp_val)}
    {% endfor %}
    RESPOND MSG="input_shaper parameters for {tool.name|replace('tool ', '')} staged for SAVE_CONFIG."
  {% endif %}
